KISSY.add("form/uploader/base",function(c,n,l,i,h,d,a){function e(b){e.superclass.constructor.call(this,b)}c.mix(e,{type:{AUTO:"auto",IFRAME:"iframe",AJAX:"ajax",FLASH:"flash"},event:{RENDER:"render",SELECT:"select",START:"start",PROGRESS:"progress",COMPLETE:"complete",SUCCESS:"success",UPLOAD_FILES:"uploadFiles",CANCEL:"cancel",ERROR:"error"},status:{}});c.extend(e,n,{render:function(){var b=this.get("serverConfig"),g=this.getUploadType(this.get("type")),f=g.event,j;if(!g)return false;this.set("urlsInput",
this._renderUrlsInput());this._renderQueue();j=this._renderButton();this.get("type")==e.type.FLASH&&c.mix(b,{swfUploader:j.get("swfUploader")});b=new g(b);b.on(f.SUCCESS,this._uploadCompleteHanlder,this);f.PROGRESS&&b.on(f.PROGRESS,this._uploadProgressHandler,this);b.on(f.STOP,this._uploadStopHanlder,this);this.set("uploadType",b);this.fire(e.event.RENDER);return this},upload:function(b){if(!c.isNumber(b))return false;var g=this.get("uploadType"),f=this.get("queue"),j=f.get("files")[b],k;if(!c.isPlainObject(j)){c.log("[uploader]:队列中不存在id为"+
b+"的文件");return false}if(this.get("curUploadIndex")!=""){alert("第"+this.get("curUploadIndex")+"文件正在上传，请上传完后再操作！");return false}k=j.input.id||j.input;this.fire(e.event.START,{index:b,file:j});if(!this.get("isAllowUpload"))return false;this.set("curUploadIndex",b);f.fileStatus(b,e.status.START);g.upload(k)},cancel:function(){this.get("uploadType").stop();return this},uploadFiles:function(b){if(!c.isString(b))b=e.status.WAITING;this.set("uploadFilesStatus",b);this._uploaderStatusFile(b);return this},
_uploaderStatusFile:function(b){b=this.get("queue").getIndexs(b);if(!b.length){this.set("uploadFilesStatus","");this.fire(e.event.UPLOAD_FILES);return false}this.upload(b[0]);return this},isSupportAjax:function(){return c.isObject(FormData)},isSupportFlash:function(){var b=c.UA.fpv();return c.isArray(b)&&b.length>0},getUploadType:function(b){var g=this,f=e.type,j;if(b==f.AUTO)b=[f.AJAX,f.IFRAME];if(c.isArray(b)&&b.length>0)c.each(b,function(k){if(j=g._getType(k))return false});else j=g._getType(b);
return j},_getType:function(b){var g=e.type,f=this.isSupportAjax(),j=this.isSupportFlash();switch(b){case g.IFRAME:g=h;break;case g.AJAX:g=f&&d||false;break;case g.FLASH:g=j&&a||false;break;default:c.log("[uploader]:type参数不合法");return false}this.set("type",b);return g},_renderButton:function(){var b=this.get("button");if(!c.isObject(b)){c.log("[uploader]:button参数不合法！");return false}b.on("change",this._select,this);b.render();return b},_renderQueue:function(){var b=this.get("queue"),g=this.get("urlsInput");
if(!c.isObject(b)){c.log("[uploader]:queue参数不合法");return false}b.set("uploader",this);b.on(b.constructor.event.REMOVE,function(f){g.remove(f.file.sUrl)});b.render();e.status=b.constructor.status;return b},_select:function(b){var g=this,f=g.get("autoUpload"),j=g.get("queue"),k=g.get("curUploadIndex"),o=b.files;c.each(o,function(m){if(!m.size)m.size=0;if(!m.name)m.name=m.fileName||"";m.input=b.input||m});g.fire(e.event.SELECT,{files:o});if(!g.get("isAllowUpload"))return false;j.add(o,function(){k==
""&&f&&g.uploadFiles()})},_renderUrlsInput:function(){var b=this.get("button").target,g=this.get("urlsInputName");b=new i(b,{name:g});b.render();return b},_uploadCompleteHanlder:function(b){b=b.result;var g,f=e.event,j=this.get("queue"),k=this.get("curUploadIndex");if(!c.isObject(b))return false;if(g=b.status){j.fileStatus(k,e.status.SUCCESS);this._success(b.data);this.fire(f.SUCCESS,{index:k,file:j.getFile(k)})}else{j.fileStatus(k,e.status.ERROR,b.msg||"");this.fire(f.ERROR,{status:g})}this.set("curUploadIndex",
"");this.fire(f.COMPLETE,{index:k,file:j.getFile(k)});b=this.get("uploadFilesStatus");b!=""&&this._uploaderStatusFile(b)},_uploadStopHanlder:function(){var b=this.get("queue"),g=this.get("curUploadIndex");b.fileStatus(g,e.status.CANCEL);this.set("curUploadIndex","");this.fire(e.event.CANCEL,{index:g})},_uploadProgressHandler:function(b){var g=this.get("queue"),f=this.get("curUploadIndex"),j=g.getFile(f);c.mix(b,{file:j});g.fileStatus(f,e.status.PROGRESS,b);this.fire(e.event.PROGRESS,b)},_success:function(b){if(!c.isObject(b))return false;
b=b.url;var g=this.get("urlsInput"),f=this.get("curUploadId"),j=this.get("queue");if(!c.isString(b)||!c.isObject(g))return false;j.updateFile(f,{sUrl:b});g.add(b)},_error:function(){}},{ATTRS:{button:{value:{}},queue:{value:{}},type:{value:e.type.AUTO},serverConfig:{value:{action:"",data:{},dataType:"json"}},isAllowUpload:{value:true},autoUpload:{value:true},urlsInputName:{value:""},curUploadIndex:{value:""},uploadType:{value:{}},urlsInput:{value:""},isUploadWaitFiles:{value:false},uploadFilesStatus:{value:""}}});
return e},{requires:["base","node","./urlsInput","./type/iframe","./type/ajax","./type/flash","flash"]});
KISSY.add("form/uploader/button/base",function(c,n,l){function i(d,a){a=c.merge({target:h(d)},a);i.superclass.constructor.call(this,a)}var h=n.all;c.mix(i,{event:{beforeShow:"beforeShow",afterShow:"afterShow",beforeHide:"beforeHide",afterHide:"afterHide",beforeRender:"beforeRender",afterRender:"afterRender",CHANGE:"change"}});c.extend(i,l,{render:function(){var d=this.get("target");if(this.fire(i.event.beforeRender)===false){c.log("[AjaxUploader-Button] button render was prevented.");return false}else{if(d==
null){c.log("[AjaxUploader-Button] Cannot find target!");return false}this._createInput();this.fire(i.event.afterRender);c.log("[AjaxUploader-Button] button was rendered just now.");return this}},show:function(){var d=this.get("target"),a=this.get("cls").disabled,e=this.get("fileInput");if(this.fire(i.event.beforeShow)===false)c.log("[AjaxUploader-Button] show button event was prevented.");else{h(d).removeClass(a);h(e).show();this.fire(i.event.afterShow);c.log("[AjaxUploader-Button] button showed.")}},
hide:function(){var d=this.get("target"),a=this.get("cls").disabled,e=this.get("fileInput");if(this.fire(i.event.beforeHide)===false)c.log("[AjaxUploader-Button] hide button event was prevented.");else{h(d).addClass(a);h(e).hide();this.fire(i.event.afterHide);c.log("[AjaxUploader-Button] button showed.")}},_reset:function(){var d=this.get("inputContainer");h(d).remove();this.set("inputContainer","");this.set("fileInput","");this._createInput();return this},_createInput:function(){var d=this.get("target"),
a=this.get("name"),e=this.get("tpl"),b=this.get("multiple");if(!c.isString(a)||!c.isString(e)){c.log("[AjaxUploader-Button] No name or tpl specified.");return false}a=c.substitute(e,{name:a});a=h(a);h(a).appendTo(d);d=h(a).children("input");b&&d.attr("multiple",b)||d.removeAttr("multiple");h(d).on("change",this._changeHandler,this);this.set("fileInput",d);this.set("inputContainer",a);return a},_changeHandler:function(d){var a=this.get("fileInput"),e=h(a).val();d=d.target.files;var b=[];if(e==""){c.log("[AjaxUploader-Button] No file selected.");
return false}c.each(d,function(g){c.isObject(g)&&b.push({name:g.name,type:g.type,size:g.size})});this.fire(i.event.CHANGE,{files:b,input:h(a).clone().getDOMNode()});c.log("[AjaxUploader-Button] button change event was fired just now.");this._reset()}},{ATTRS:{target:{value:null},fileInput:{value:""},inputContainer:{value:""},tpl:{value:'<div class="file-input-wrapper"><input type="file" name="{name}" hidefoucs="true" class="file-input" /></div>'},name:{value:"fileInput",setter:function(d){this.get("fileInput")&&
h(this.get("fileInput")).attr("name",d);return d}},disabled:{value:false,setter:function(d){d?this.hide():this.show();return d}},multiple:{value:true,setter:function(d){var a=this.get("fileInput");if(a.length)d&&a.attr("multiple","multiple")||a.removeAttr("multiple");return d}},cls:{value:{disabled:"uploader-button-disabled"}}}});return i},{requires:["node","base"]});
KISSY.add("form/uploader/button/swfButton",function(c,n,l,i){function h(a,e){e=c.merge({target:d(a)},e);h.superclass.constructor.call(this,e)}var d=n.all;c.mix(h,{event:{RENDER:"render",CHANGE:"change",MOUSE_OVER:"mouseOver",MOUSE_DOWN:"mouseDown",MOUSE_UP:"mouseUp",MOUSE_OUT:"mouseOut",CLICK:"click"}});c.extend(h,l,{render:function(){var a=this,e=a.get("target"),b,g=a.get("multiple"),f=a.get("fileFilters");e.css("position","relative");a.set("swfWrapper",a._createSwfWrapper());a._setFlashSizeConfig();
b=a._initSwfUploader();b.on("contentReady",function(){b.browse(g,f);a._bindBtnEvent();b.on("fileSelect",a._changeHandler,a);a._setDisabled(a.get("disabled"));a.fire(h.event.RENDER)},a)},_createSwfWrapper:function(){var a=this.get("target"),e=this.get("tpl"),b=this.get("swfWrapperId")!=""&&this.get("swfWrapperId")||"swf-uploader-wrapper-"+c.guid();e=c.substitute(e,{id:b});this.set("swfWrapperId",b);return d(e).appendTo(a)},_initSwfUploader:function(){var a=this.get("flash"),e=this.get("swfWrapperId"),
b;try{b=new i(e,a);this.set("swfUploader",b)}catch(g){}return b},_bindBtnEvent:function(){var a=this,e=h.event,b=a.get("swfUploader");if(!b)return false;c.each(e,function(g){b.on(g,function(){a.fire(g)},a)});return a},_setFlashSizeConfig:function(){var a=this.get("flash"),e=this.get("target");c.mix(a.attrs,{width:e.width(),height:e.height()});this.set("flash",a)},_changeHandler:function(a){this.fire(h.event.CHANGE,{files:a.fileList})},_setDisabled:function(a){var e=this.get("swfUploader"),b=this.get("cls").disabled,
g=this.get("target"),f=this.get("swfWrapper");if(!e||!c.isBoolean(a))return false;if(a){g.addClass(b);f.hide()}else{g.removeClass(b);f.show()}return a}},{ATTRS:{target:{value:""},swfWrapper:{value:""},swfWrapperId:{value:""},tpl:{value:'<div id="{id}" class="uploader-button-swf" style="position: absolute;top:0;left:0;"></div>'},multiple:{value:true,setter:function(a){var e=this.get("swfUploader");e&&e.multifile(a);return a}},fileFilters:{value:[],setter:function(a){var e=this.get("swfUploader");e&&
c.isArray(a)&&e.filter(a);return a}},disabled:{value:false,setter:function(a){this.get("swfUploader")&&this._setDisabled(a);return a}},cls:{value:{disabled:"uploader-button-disabled"}},flash:{value:{src:"../plugins/ajbridge/uploader.swf",id:"swfUploader",params:{bgcolor:"#fff",wmode:"transparent"},attrs:{},hand:true,btn:true}},swfUploader:{value:""}}});return h},{requires:["node","base","form/uploader/plugins/ajbridge/uploader"]});
KISSY.add("form/uploader/plugins/ajbridge/ajbridge",function(c,n){function l(e,b,g){e=e.replace(i,"");b=n._normalize(b||{});var f=this;e=i+e;var j=function(k){if(k.status<1)f.fire("failed",{data:k});else{c.mix(f,k);if(!k.dynamic||!b.src)f.activate()}};b.id=b.id||c.guid(h);l.instances[b.id]=f;if(b.src){b.params.allowscriptaccess="always";b.params.flashvars=c.merge(b.params.flashvars,{jsEntry:a,swfID:b.id})}if(g)f.__args=[e,b,j];else c.later(n.add,d,false,n,[e,b,j])}var i="#",h="ks-ajb-",d=100,a="KISSY.AJBridge.eventHandler";
c.app(l,{version:"1.0.15",instances:{},eventHandler:function(e,b){var g=l.instances[e];g&&g.__eventHandler(e,b)},augment:function(e,b){if(c.isString(b))b=[b];c.isArray(b)&&c.each(b,function(g){e.prototype[g]=function(){try{return this.callSWF(g,c.makeArray(arguments))}catch(f){this.fire("error",{message:f})}}})}});c.augment(l,c.EventTarget,{init:function(){if(this.__args){n.add.apply(n,this.__args);this.__args=null;delete this.__args}},__eventHandler:function(e,b){var g=b.type;b.id=e;switch(g){case "log":c.log(b.message);
break;default:this.fire(g,b)}},callSWF:function(e,b){b=b||[];try{if(this.swf[e])return this.swf[e].apply(this.swf,b)}catch(g){var f="";if(b.length!==0)f="'"+b.join("','")+"'";return(new Function("self","return self.swf."+e+"("+f+");"))(this)}}});l.augment(l,["activate","getReady","getCoreVersion"]);return window.AJBridge=c.AJBridge=l},{requires:["flash"]});
KISSY.add("form/uploader/plugins/ajbridge/uploader",function(c,n,l){function i(h,d){d=d||{};var a={};c.each(["ds","dsp","btn","hand"],function(e){if(e in d)a[e]=d[e]});d.params=d.params||{};d.params.flashvars=c.merge(d.params.flashvars,a);i.superclass.constructor.call(this,h,d)}c.extend(i,l);l.augment(i,["setFileFilters","filter","setAllowMultipleFiles","multifile","browse","upload","uploadAll","cancel","getFile","removeFile","lock","unlock","setBtnMode","useHand","clear"]);i.version="1.0.1";l.Uploader=
i;return l.Uploader},{requires:["flash","form/uploader/plugins/ajbridge/ajbridge"]});
KISSY.add(function(c){function n(h){var d={mode:"filter",maxWidth:40,maxHeight:40,onError:function(){return 1},preview:true,destroy:true};this.event={check:"check",show:"show",error:"error"};if(typeof window.FileReader==="undefined")switch(c.UA.shell){case "firefox":d.mode="domfile";break;case "ie":switch(c.UA.ie){case 6:d.mode="simple";break;default:d.mode="filter"}break;default:d.mode="simple";d.preview=false}else d.mode="html5";this.config=c.mix(d,h);c.log(i+"Preview initialized.")}var l=c.DOM,
i="[Plugin: Preview] ";c.augment(n,c.EventTarget,{preview:function(h,d){function a(){switch(f.config.mode){case "filter":f.file.select();k=g;try{return j.selection.createRange().text}catch(m){c.log("[UploadPreview] Get image data error, the error is: ");c.log(m,"dir")}finally{j.selection.empty()}break;case "domfile":k=b;return f.file.files[0].getAsDataURL();case "html5":var p=new FileReader;p.onload=function(q){e(q.target.result)};p.onerror=function(){c.log("[UploadPreview] File Reader Error. Your browser may not fully support html5 file api",
"warning")};p.readAsDataURL(f.file.files[0]);return false;case "remote":k=remotePreview;c.log("[UploadPreview] This function is not supported right now.");break;default:k=b;return f.file.value}}function e(m,p,q){f.img.src=m;if(p>1&&q>1){var r=Math.min(1,Math.max(0,f.config.maxWidth)/p||1,Math.max(0,f.config.maxHeight)/q||1);f.img.style.width=Math.round(p*r)+"px";f.img.style.height=Math.round(q*r)+"px";f.img.setAttribute("data-ratio",r)}l.attr(f.img,"data-ks-imagezoom",f.config.mode=="filter"?f.data:
m);f.fire(f.event.show)}function b(){e(f.data)}function g(){if(!f.preload){f.preload=document.createElement("div");l.css(f.preload,{visibility:"hidden",position:"absolute",left:"-9999px",top:"-9999px",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='image')"});var m=document.body;m.insertBefore(f.preload,m.childNodes[0]);m=null}f.data=f.data.replace(/[)'"%]/g,function(q){return escape(escape(q))});c.log("[UploadPreview] This escaped data is "+f.data);try{f.preload.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=
f.data}catch(p){f._error("[UploadPreview] Filter error")}f.img.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src=\""+f.data+'")';f.img.zoom=1;f.img.setAttribute("data-ks-imagezoom",f.data);e(f.TRANSPARENT,f.preload.offsetWidth,f.preload.offsetHeight)}var f=this,j=document,k;f.file=h;f.img=d;f.preload=null;f.data=null;f.TRANSPARENT=c.UA.ie==6||c.UA.ie==7?"http://a.tbcdn.cn/p/fp/2011a/assets/space.gif":"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
if(f.file){c.log("[UploadPreview] One file selected. Using "+f.config.mode+" mode to preview.");if(f.fire(f.event.check)!==false){var o=a();c.log("[UploadPreview] Get data done. The data is "+o);if(o&&o!==f.data){f.data=o;o=null;k()}}else c.log("[UploadPreview] Check error.")}},setConfig:function(h){self.config=c.mix(self.config,h)},destroy:function(){if(this._upload){this._upload.dispose();this._upload=null}this.file=this.img=this.data=this.preload=null},_error:function(h){c.log(h)}});return n});
KISSY.add("form/uploader/preview/preview",function(c){function n(h){var d={mode:"filter",maxWidth:40,maxHeight:40,onError:function(){return 1},preview:true,destroy:true};this.event={check:"check",show:"show",error:"error"};if(typeof window.FileReader==="undefined")switch(c.UA.shell){case "firefox":d.mode="domfile";break;case "ie":switch(c.UA.ie){case 6:d.mode="simple";break;default:d.mode="filter"}break;default:d.mode="simple";d.preview=false}else d.mode="html5";this.config=c.mix(d,h);c.log(i+"Preview initialized.")}
var l=c.DOM,i="[Plugin: Preview] ";c.augment(n,c.EventTarget,{preview:function(h,d){function a(){switch(f.config.mode){case "filter":f.file.select();k=g;try{return j.selection.createRange().text}catch(m){c.log("[UploadPreview] Get image data error, the error is: ");c.log(m,"dir")}finally{j.selection.empty()}break;case "domfile":k=b;return f.file.files[0].getAsDataURL();case "html5":var p=new FileReader;p.onload=function(q){e(q.target.result)};p.onerror=function(){c.log("[UploadPreview] File Reader Error. Your browser may not fully support html5 file api",
"warning")};p.readAsDataURL(f.file.files[0]);return false;case "remote":k=remotePreview;c.log("[UploadPreview] This function is not supported right now.");break;default:k=b;return f.file.value}}function e(m,p,q){f.img.src=m;if(p>1&&q>1){var r=Math.min(1,Math.max(0,f.config.maxWidth)/p||1,Math.max(0,f.config.maxHeight)/q||1);f.img.style.width=Math.round(p*r)+"px";f.img.style.height=Math.round(q*r)+"px";f.img.setAttribute("data-ratio",r)}l.attr(f.img,"data-ks-imagezoom",f.config.mode=="filter"?f.data:
m);f.fire(f.event.show)}function b(){e(f.data)}function g(){if(!f.preload){f.preload=document.createElement("div");l.css(f.preload,{visibility:"hidden",position:"absolute",left:"-9999px",top:"-9999px",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='image')"});var m=document.body;m.insertBefore(f.preload,m.childNodes[0]);m=null}f.data=f.data.replace(/[)'"%]/g,function(q){return escape(escape(q))});c.log("[UploadPreview] This escaped data is "+f.data);try{f.preload.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=
f.data}catch(p){f._error("[UploadPreview] Filter error")}f.img.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src=\""+f.data+'")';f.img.zoom=1;f.img.setAttribute("data-ks-imagezoom",f.data);e(f.TRANSPARENT,f.preload.offsetWidth,f.preload.offsetHeight)}var f=this,j=document,k;f.file=h;f.img=d;f.preload=null;f.data=null;f.TRANSPARENT=c.UA.ie==6||c.UA.ie==7?"http://a.tbcdn.cn/p/fp/2011a/assets/space.gif":"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
if(f.file){c.log("[UploadPreview] One file selected. Using "+f.config.mode+" mode to preview.");if(f.fire(f.event.check)!==false){var o=a();c.log("[UploadPreview] Get data done. The data is "+o);if(o&&o!==f.data){f.data=o;o=null;k()}}else c.log("[UploadPreview] Check error.")}},setConfig:function(h){self.config=c.mix(self.config,h)},destroy:function(){if(this._upload){this._upload.dispose();this._upload=null}this.file=this.img=this.data=this.preload=null},_error:function(h){c.log(h)}});return n});
KISSY.add("form/uploader/plugins/progressBar/progressBar",function(c,n,l){function i(d,a){a=c.merge({wrapper:h(d)},a);i.superclass.constructor.call(this,a)}var h=n.all;c.mix(i,{tpl:{DEFAULT:'<div class="ks-progress-bar-value" data-value="{value}"></div>'},cls:{PROGRESS_BAR:"ks-progress-bar",VALUE:"ks-progress-bar-value"},event:{RENDER:"render",CHANGE:"change",SHOW:"show",HIDE:"hide"}});c.extend(i,l,{render:function(){var d=this.get("wrapper"),a=this.get("width");if(!d.length)return false;d.addClass(i.cls.PROGRESS_BAR).width(a);
this._addAttr();!this.get("visible")&&this.hide();this.set("bar",this._create());this.fire(i.event.RENDER)},show:function(){var d=this;d.get("wrapper").fadeIn(d.get("duration"),function(){d.set("visible",true);d.fire(i.event.SHOW,{visible:true})})},hide:function(){var d=this;d.get("wrapper").fadeOut(d.get("duration"),function(){d.set("visible",false);d.fire(i.event.HIDE,{visible:false})})},_create:function(){var d=this.get("wrapper"),a=this.get("value"),e=this.get("tpl");a=c.substitute(e,{value:a});
d.html("");return h(a).appendTo(d)},_addAttr:function(){var d=this.get("wrapper"),a=this.get("value");d.attr("role","progressbar");d.attr("aria-valuemin",0);d.attr("aria-valuemax",100);d.attr("aria-valuenow",a);return this}},{ATTRS:{wrapper:{value:""},bar:{value:""},width:{value:100},value:{value:0,setter:function(d){var a=this,e=a.get("wrapper"),b=a.get("bar"),g=a.get("speed"),f;if(d>100)d=100;if(d<0)d=0;f=e.width()*(d/100);b.animate({width:f+"px"},g,"none",function(){e.attr("aria-valuenow",d);b.attr("data-value",
d);a.fire(i.event.CHANGE,{value:d,width:f})});return d}},visible:{value:true},duration:{value:0.3},tpl:{value:i.tpl.DEFAULT},speed:{value:0.2}}});return i},{requires:["node","base"]});
KISSY.add("form/uploader/queue/base",function(c,n,l,i){function h(a,e){h.superclass.constructor.call(this,e);this.set("target",d(a))}var d=n.all;c.mix(h,{tpl:{DEFAULT:'<li id="queue-file-{id}" class="clearfix" data-name="{name}"><div class="f-l sprite file-icon"></div><div class="f-l">{name}</div><div class="f-l file-status J_FileStatus"></div></li>'},event:{ADD:"add",REMOVE:"remove",CLEAR:"clear"},status:i.type,cls:{QUEUE:"ks-uploader-queue"},hook:{STATUS:".J_FileStatus"},FILE_ID_PREFIX:"file-"});
c.extend(h,l,{render:function(){this.get("target").addClass(h.cls.QUEUE);return this},add:function(a,e){var b=this,g=h.event;if(a.length>0){b._addFiles(a,function(){e&&e.call(b);b.fire(g.ADD)});return false}else return b._addFile(a,function(f,j){e&&e.call(b,f,j);b.fire(g.ADD,{index:f,file:j,target:j.target})})},_addFile:function(a,e){if(!c.isObject(a)){c.log("[uploader-queue]:_addFile()参数file不合法！");return false}var b=this,g=b.get("duration"),f=b._setAddFileData(a),j=b.getFileIndex(f.id);b.fileStatus(j,
h.status.WAITING);f.target.fadeIn(g,function(){e&&e.call(b,j,f)});return f},_addFiles:function(a,e){function b(f){if(f===a.length){e&&e.call(this);return false}g._addFile(a[f],function(){f++;b(f)})}if(!a.length){c.log("[uploader-queue]:_addFiles()参数files不合法！");return false}var g=this;b(0)},remove:function(a,e){var b=this,g=b.get("files"),f,j,k=b.get("duration");if(c.isString(a))a=b.getFileIndex(a);f=g[a];if(!c.isObject(f)){c.log("[uploader-queue]:remove()不存在index为"+a+"的文件数据");return false}j=f.target;
j.fadeOut(k,function(){j.remove();e&&e.call(b,a,f);b.fire(h.event.REMOVE,{index:a,file:f})});g=c.filter(g,function(o,m){return m!==a});b.set("files",g);return f},clear:function(){function a(){b=e.get("files");if(!b.length){e.fire(h.event.CLEAR);return false}e.remove(0,function(){a()})}var e=this,b;a()},fileStatus:function(a,e,b){if(!c.isNumber(a))return false;a=this.getFile(a);if(!c.isPlainObject(a))return false;a=a.status;e&&a.change(e,b);return a},getFile:function(a){if(!c.isNumber(a))return false;
a=this.get("files")[a];c.isPlainObject(a)||(a=false);return a},getFileIndex:function(a){var e=this.get("files"),b=-1;c.each(e,function(g,f){if(g.id==a){b=f;return true}});return b},updateFile:function(a,e){if(!c.isNumber(a))return false;if(!c.isObject(e)){c.log("[uploader-queue]:updateFile()的data参数有误！");return false}var b=this.get("files"),g=this.getFile(a);if(!g)return false;c.mix(g,e);b[a]=g;this.set("files",b);return g},getIndexs:function(a){var e=this.get("files"),b,g=[];if(!e.length)return g;
c.each(e,function(f,j){if(c.isObject(f)){b=f.status;b.get("curType")==a&&g.push(j)}});return g},getFiles:function(a){var e=this.get("files"),b,g=[];if(!e.length)return false;c.each(e,function(f){if(f){b=f.status;b.get("curType")==a&&g.push(f)}});return g},_setAddFileData:function(a){var e=this.get("files"),b=this.get("uploader");if(!c.isObject(a)){c.log("[uploader-queue]:_updateFileData()参数file不合法！");return false}if(!a.id)a.id=c.guid(h.FILE_ID_PREFIX);if(a.size)a.textSize=i.convertByteSize(a.size);
a.target=this._appendFileHtml(a);a.status=this._renderStatus(a);c.isObject(b)&&a.status.set("uploader",b);e.push(a);return a},_appendFileHtml:function(a){var e=this.get("target"),b=this.get("tpl");b=c.substitute(b,a);return d(b).hide().appendTo(e).data("data-file",a)},_renderStatus:function(a){var e=a.target;if(!e.length)return false;e=e.children(h.hook.STATUS);return new i(e,{queue:this,file:a})}},{ATTRS:{tpl:{value:h.tpl.DEFAULT},duration:{value:0.3},target:{value:""},files:{value:[]},uploader:{value:""}}});
return h},{requires:["node","base","./status"]});
KISSY.add("form/uploader/queue/status",function(c,n,l,i){function h(a,e){e=c.merge({target:d(a)},e);h.superclass.constructor.call(this,e)}var d=n.all;c.mix(h,{type:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error"},convertByteSize:function(a){var e=-1;do{a/=1024;e++}while(a>99);return Math.max(a,0.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][e]}});c.extend(h,l,{change:function(a,e){if(!c.isString(a))return false;var b;if(!this.isSupport(a)){c.log("[queue-status]:status参数为"+
a+"，不支持的状态类型");return false}e||(e={});(b=this["_"+a])&&b.call(this,e);this.set("curType",a);return this},isSupport:function(a){if(!c.isString(a))return false;var e=false;c.each(h.type,function(b){if(a==b)return e=true});return e},_changeDom:function(a){var e=this.get("target");e.html("");return d(a).appendTo(e)},_waiting:function(){var a=this.get("tpl").waiting,e=this.get("uploader"),b=this.get("queue"),g=this.get("file").id,f=b.getFileIndex(g);this._changeDom(a).children(".J_Upload").on("click",
function(j){j.preventDefault();if(!c.isObject(e))return false;e.upload(f)})},_start:function(){var a=this.get("tpl").start,e=this.get("target"),b=this.get("uploader"),g=b.get("type");if(!c.isString(a))return false;a=this._changeDom(a);a.children(".J_UploadCancel").on("click",function(f){f.preventDefault();if(!c.isObject(b))return false;b.cancel()});if(g=="ajax"||g=="flash"){g=a.children(".J_ProgressBar");g=new i(g);g.render();this.set("progressBar",g)}e.parent().addClass("current-upload-file")},_progress:function(a){a=
Math.ceil(a.loaded/a.total)*100;var e=this.get("progressBar");if(!e)return false;e.set("value",a)},_success:function(){var a=this.get("tpl").success,e=this.get("target"),b=this.get("queue"),g=this.get("file").id,f=this.get("progressBar"),j=this.get("target"),k;if(!c.isString(a))return false;if(c.isObject(f))k=j.children().children(".J_ProgressBar").clone(true);a=this._changeDom(a);k&&a.prepend(k);a.children(".J_FileDel").on("click",function(o){o.preventDefault();b.remove(g)});e.parent().removeClass("current-upload-file")},
_cancel:function(){var a=this.get("tpl").cancel,e=this.get("uploader");a=this._changeDom(a).children(".J_ReUpload");var b=this.get("file").id;a.on("click",function(g){g.preventDefault();if(!c.isObject(e))return false;e.upload(b)})},_error:function(a){c.isObject(a)||(a={msg:"文件上传失败！"});var e=this.get("tpl").error;a=this._changeDom(c.substitute(e,a)).children(".J_FileDel");var b=this.get("queue"),g=this.get("file").id;a.on("click",function(f){f.preventDefault();b.remove(g)})}},{ATTRS:{target:{value:""},
tpl:{value:{waiting:'<div class="waiting-status">等待上传，<a href="#Upload" class="J_Upload">点此上传</a> </div>',start:'<div class="start-status clearfix"><div class="f-l  J_ProgressBar uploader-progress"><img class="loading" src="http://img01.taobaocdn.com/tps/i1/T1F5tVXjRfXXXXXXXX-16-16.gif" alt="loading" /></div> <a class="f-l J_UploadCancel upload-cancel" href="#uploadCancel">取消</a></div> ',success:' <div class="success-status"><a href="#fileDel" class="J_FileDel">删除</a></div>',cancel:'<div class="cancel-status">已经取消上传，<a href="#reUpload" class="J_ReUpload">点此重新上传</a> </div>',
error:'<div class="error-status upload-error">{msg}<a href="#fileDel" class="J_FileDel">点此删除</a></div>'}},queue:{value:""},uploader:{value:""},file:{value:{}},curType:{value:""},progressBar:{value:""}}});return h},{requires:["node","base","../plugins/progressBar/progressBar"]});
KISSY.add("form/uploader/render",function(c,n,l,i,h,d){function a(j,k){var o={},m,p=k||f.CONFIG;m=b(j).attr(p);if(!c.isString(m))return{};try{o=JSON.parse(m)}catch(q){c.log(g+"请检查"+j+"上"+p+"属性内的json格式是否符合规范！")}return o}function e(j,k,o){o=c.mix(a(j),o);e.superclass.constructor.call(this,o);this.set("buttonTarget",j);this.set("queueTarget",k);this.set("uploaderConfig",o);this._init()}var b=l.all,g="[uploaderRender]:",f={CONFIG:"data-config"};c.extend(e,n,{_init:function(){var j=this,k=j.get("uploaderConfig"),
o=j._initButton(),m;j.set("button",o);j._initThemes(function(p){m=p.get("queue");c.mix(k,{button:o,queue:m});var q=new i(k);q.render();j.set("uploader",q);p.afterUploaderRender&&p.afterUploaderRender(q);j.fire("init",{uploader:q})})},_initButton:function(){var j=this.get("buttonTarget"),k=this.get("name");return this.get("type")!="flash"&&new h(j,{name:k})||new d(j)},_initThemes:function(j){var k=this,o=k.get("theme");c.use(o+"/index",function(m,p){var q=k.get("queueTarget");q=new p({queueTarget:q});
j&&j.call(k,q)})},_initQueue:function(){var j=this.get("queueTarget");return new Queue(j)},_auth:function(){}},{ATTRS:{theme:{value:"form/uploader/themes/default"},buttonTarget:{value:""},queueTarget:{value:""},uploaderConfig:{},button:{value:""},queue:{value:""},uploader:{value:""}}});return e},{requires:["base","node","./base","./button/base","./button/swfButton"]});
KISSY.add("form/uploader/type/ajax",function(c,n,l){function i(d){i.superclass.constructor.call(this,d);this._processData()}var h=n.all;c.mix(i,{event:c.merge(l.event,{PROGRESS:"progress"})});c.extend(i,l,{upload:function(d){if(!d){c.log("[uploader-AjaxType]:upload()，fileInput参数有误！");return false}var a=d.files;if(!a.length){c.log("[uploader-AjaxType]:upload()，不存在要上传的文件！");return false}this._addFileData(d,a[0]);this.send();return this},stop:function(){var d=this.get("xhr");if(!c.isObject(d)){c.log("[uploader-AjaxType]:stop()，io值错误！");
return false}d.abort();this.fire(i.event.STOP);return this},send:function(){var d=this,a=d.get("action"),e=d.get("formData"),b=new XMLHttpRequest;b.upload.addEventListener("progress",function(g){d.fire(i.event.PROGRESS,{loaded:g.loaded,total:g.total})});b.onload=function(){var g={};try{g=c.JSON.parse(b.responseText)}catch(f){c.log("[uploader-AjaxType]:ajax返回结果集responseText格式不合法！")}d.fire(i.event.SUCCESS,{result:g})};b.open("POST",a,true);b.send(e);d.set("xhr",b);return d},_processData:function(){var d=
this.get("data"),a=this.get("formData");c.each(d,function(e,b){a.append(b,e)});this.set("formData",a)},_addFileData:function(d,a){if(!c.isObject(a)){c.log("[uploader-AjaxType]:_addFileData()，file参数有误！");return false}var e=this.get("formData"),b=this.get("fileDataName");if(b==""){b=h(d).attr("name");this.set("fileDataName",b)}e.append(b,a);this.set("formData",e)}},{ATTRS:{formData:{value:new FormData},ajaxConfig:{value:{type:"post",processData:false,cache:false,dataType:"json",contentType:false}},
xhr:{value:""},fileDataName:{value:""},form:{value:{}},fileInput:{value:""}}});return i},{requires:["node","./base"]});KISSY.add("form/uploader/type/base",function(c,n,l){function i(h){i.superclass.constructor.call(this,h)}c.mix(i,{event:{START:"start",STOP:"stop",SUCCESS:"success",ERROR:"error"}});c.extend(i,l,{upload:function(){},stop:function(){}},{ATTRS:{action:{value:""},data:{value:{}}}});return i},{requires:["node","base"]});
KISSY.add("form/uploader/type/flash",function(c,n,l){function i(h){i.superclass.constructor.call(this,h);this._init()}c.mix(i,{event:c.merge(l.event,{SWF_READY:"swfReady",PROGRESS:"progress"})});c.extend(i,l,{_init:function(){var h=this,d=h.get("swfUploader");if(!d){c.log("[uploader-FlashType]:swfUploader对象为空！");return false}d.on("contentReady",function(){h.fire(i.event.SWF_READY)},h);d.on("uploadStart",h._uploadStartHandler,h);d.on("uploadProgress",h._uploadProgressHandler,h);d.on("uploadCompleteData",
h._uploadCompleteDataHandler,h);d.on("uploadError",h._uploadErrorHandler,h)},upload:function(h){var d=this.get("swfUploader"),a=this.get("action"),e=this.get("data");this.set("uploadingId",h);d.upload(h,a,"POST",e);return this},stop:function(){var h=this.get("swfUploader"),d=this.get("uploadingId");if(d!=""){h.cancel(d);this.fire(i.event.STOP,{id:d})}return this},_uploadStartHandler:function(h){this.fire(i.event.START,{file:h.file})},_uploadProgressHandler:function(h){c.mix(h,{loaded:h.bytesLoaded,
total:h.bytesTotal});this.fire(i.event.PROGRESS,{loaded:h.loaded,total:h.total})},_uploadCompleteDataHandler:function(h){var d;try{d=JSON.parse(h.data)}catch(a){c.log("[uploader-FlashType]:json数据格式不合法！");this.fire(i.event.ERROR,{msg:"不是合法的json数据"})}this.set("uploadingId","");this.fire(i.event.SUCCESS,{result:d})},_uploadErrorHandler:function(h){this.set("uploadingId","");this.fire(i.event.ERROR,{msg:h.msg})}},{ATTRS:{swfUploader:{value:""},uploadingId:{value:""}}});return i},{requires:["node","./base"]});
KISSY.add("form/uploader/type/iframe",function(c,n,l){function i(d){i.superclass.constructor.call(this,d)}var h=n.all;c.mix(i,{tpl:{IFRAME:'<iframe src="javascript:false;" name="{id}" id="{id}" border="no" width="1" height="1" style="display: none;" />',FORM:'<form method="post" enctype="multipart/form-data" action="{action}" target="{target}">{hiddenInputs}</form>',HIDDEN_INPUT:'<input type="hidden" name="{name}" value="{value}" />'},event:c.mix(l.event,{CREATE:"create",REMOVE:"remove"})});c.extend(i,
l,{upload:function(d){d=h(d);if(!d.length)return false;this.fire(i.event.START,{input:d});this.set("fileInput",d);this._create();this.get("form").getDOMNode().submit()},stop:function(){this.get("iframe").attr("src",'javascript:"<html></html>";');this.fire(i.event.STOP);this.fire(i.event.ERROR,{status:"abort",msg:"上传失败，原因：abort"});return this},dataToHidden:function(d){if(!c.isObject(d)||c.isEmptyObject(d)){c.log("[uploader-iframeType]:data参数不是对象或者为空！");return false}var a="",e=this.get("tpl").HIDDEN_INPUT;
if(!c.isString(e))return false;for(var b in d)a+=c.substitute(e,{name:b,value:d[b]});return a},_createIframe:function(){var d=this.get("id"),a=this.get("tpl"),e=a.IFRAME,b=this.get("iframe");if(!c.isEmptyObject(b))return b;if(!c.isString(e)){c.log("[uploader-iframeType]:iframe的模板不合法！");return false}if(!c.isString(d)){c.log("[uploader-iframeType]:id必须存在且为字符串类型！");return false}d=c.substitute(a.IFRAME,{id:d});d=h(d);d.on("load",this._iframeLoadHandler,this);h("body").append(d);this.set("iframe",d);return d},
_iframeLoadHandler:function(d){var a=d.target;d=i.event.ERROR;a=a.contentDocument||window.frames[a.id].document;if(!a||!a.body){this.fire(d,{msg:"服务器端返回数据有问题！"});return false}a=a.body.innerHTML;if(a=="")return false;try{a=JSON.parse(a)}catch(e){c.log("[uploader-iframeType]:json数据格式不合法！");this.fire(d,{msg:"数据："+a+"不是合法的json数据"})}this.fire(i.event.SUCCESS,{result:a});this._remove()},_createForm:function(){var d=this.get("id"),a=this.get("tpl").FORM,e=this.get("data"),b=this.get("action"),g=this.get("fileInput"),
f="";if(!c.isString(a)){c.log("[uploader-iframeType]:form模板不合法！");return false}if(!c.isObject(e)){c.log("[uploader-iframeType]:data参数不合法！");return false}if(!c.isString(b)){c.log("[uploader-iframeType]:action参数不合法！");return false}e=this.dataToHidden(e);if(e=="")return false;f=c.substitute(a,{action:b,target:d,hiddenInputs:e});d=h(f).append(g.clone());h("body").append(d);this.set("form",d);return d},_create:function(){var d=this._createIframe(),a=this._createForm();this.fire(i.event.CREATE,{iframe:d,
form:a})},_remove:function(){var d=this.get("form");this.get("iframe");d.remove();this.reset("form");this.fire(i.event.REMOVE,{form:d})}},{ATTRS:{tpl:{value:i.tpl},id:{value:"ks-uploader-iframe-"+c.guid()},iframe:{value:{}},form:{value:{}},fileInput:{value:""}}});return i},{requires:["node","./base"]});
KISSY.add("form/uploader/urlsInput",function(c,n,l){function i(d,a){i.superclass.constructor.call(this,a);this.set("wrapper",h(d))}var h=n.all;c.mix(i,{TPL:'<input type="hidden" id="{name}" name="{name}" value="{value}" />'});c.extend(i,l,{render:function(){var d=this.get("wrapper"),a=this.get("name");a=document.getElementsByName(a)[0];if(!c.isObject(d)){c.log("[uploader-urlsInput]:container参数不合法！");return false}a?this.set("input",h(a)):this._create()},add:function(d){if(!c.isString(d)){c.log("[uploader-urlsInput]:add()的url参数不合法！");
return false}var a=this.get("urls");if(this.isExist(d)){c.log("[uploader-urlsInput]:add()，文件路径已经存在！");return this}a.push(d);this.set("urls",a);this._val();return this},remove:function(d){var a=this.get("urls");if(!this.isExist(d)){c.log("[uploader-urlsInput]:remove()，不存在该文件路径！");return false}a=c.filter(a,function(e){return e!=d});this.set("urls",a);this._val();return a},_val:function(){var d=this.get("urls"),a=this.get("input"),e=this.get("split");d=d.join(e);a.val(d);return d},isExist:function(d){var a=
false,e=this.get("urls");if(!e.length)return false;c.each(e,function(b){if(b==d)return a=true});return a},_create:function(){var d=this.get("wrapper"),a=this.get("tpl"),e=this.get("name"),b=this.get("urls");if(!c.isString(a)||!c.isString("name")){c.log("[uploader-urlsInput]:_create()，tpl和name属性不合法！");return false}a=h(c.substitute(a,{name:e,value:b}));d.append(a);this.set("input",a);return a}},{ATTRS:{name:{value:""},urls:{value:[]},tpl:{value:i.TPL},split:{value:",",setter:function(d){this._val();
return d}},input:{value:""},wrapper:{value:""}}});return i},{requires:["node","base"]});
