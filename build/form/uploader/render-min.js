KISSY.add("form/uploader/base",function(c,n,l,i,h,e,a){function f(b){f.superclass.constructor.call(this,b)}c.mix(f,{type:{AUTO:"auto",IFRAME:"iframe",AJAX:"ajax",FLASH:"flash"},event:{RENDER:"render",SELECT:"select",START:"start",PROGRESS:"progress",COMPLETE:"complete",SUCCESS:"success",UPLOAD_FILES:"uploadFiles",CANCEL:"cancel",ERROR:"error"},status:{}});c.extend(f,n,{render:function(){var b=this.get("serverConfig"),g=this.getUploadType(this.get("type")),d=g.event,j;if(!g)return false;this.set("urlsInput",
this._renderUrlsInput());this._renderQueue();j=this._renderButton();this.get("type")==f.type.FLASH&&c.mix(b,{swfUploader:j.get("swfUploader")});b=new g(b);b.on(d.SUCCESS,this._uploadCompleteHanlder,this);d.PROGRESS&&b.on(d.PROGRESS,this._uploadProgressHandler,this);b.on(d.STOP,this._uploadStopHanlder,this);this.set("uploadType",b);this.fire(f.event.RENDER);return this},upload:function(b){if(!c.isNumber(b))return false;var g=this.get("uploadType"),d=this.get("queue"),j=d.get("files")[b],k;if(!c.isPlainObject(j)){c.log("[uploader]:队列中不存在id为"+
b+"的文件");return false}if(this.get("curUploadIndex")!=""){alert("第"+this.get("curUploadIndex")+"文件正在上传，请上传完后再操作！");return false}k=j.input.id||j.input;if(d.fileStatus(b).get("curType")==="error")return false;this.fire(f.event.START,{index:b,file:j});if(!this.get("isAllowUpload"))return false;this.set("curUploadIndex",b);d.fileStatus(b,f.status.START);g.upload(k)},cancel:function(b){var g=this.get("uploadType"),d=this.get("queue"),j=f.status,k=d.fileStatus(b);if(c.isNumber(b)&&k!=j.SUCCESS)d.fileStatus(b,
j.CANCEL);else{g.stop();this._continueUpload()}return this},stop:function(){this.set("uploadFilesStatus","");this.cancel();return this},uploadFiles:function(b){if(!c.isString(b))b=f.status.WAITING;this.set("uploadFilesStatus",b);this._uploaderStatusFile(b);return this},_uploaderStatusFile:function(b){b=this.get("queue").getIndexs(b);if(!b.length){this.set("uploadFilesStatus","");this.fire(f.event.UPLOAD_FILES);return false}this.upload(b[0]);return this},isSupportAjax:function(){var b=false;try{b=
c.isFunction(FormData)}catch(g){b=false}return b},isSupportFlash:function(){var b=c.UA.fpv();return c.isArray(b)&&b.length>0},getUploadType:function(b){var g=this,d=f.type,j;if(b==d.AUTO)b=[d.AJAX,d.IFRAME];if(c.isArray(b)&&b.length>0)c.each(b,function(k){if(j=g._getType(k))return false});else j=g._getType(b);return j},_getType:function(b){var g=f.type,d=this.isSupportAjax(),j=this.isSupportFlash();switch(b){case g.IFRAME:g=h;break;case g.AJAX:g=d&&e||false;break;case g.FLASH:g=j&&a||false;break;
default:c.log("[uploader]:type参数不合法");return false}g&&c.log("[uploader]:使用"+b+"上传方式");this.set("type",b);return g},_renderButton:function(){var b=this.get("button");if(!c.isObject(b)){c.log("[uploader]:button参数不合法！");return false}b.on("change",this._select,this);b.render();return b},_renderQueue:function(){var b=this.get("queue"),g=this.get("urlsInput");if(!c.isObject(b)){c.log("[uploader]:queue参数不合法");return false}b.set("uploader",this);b.on(b.constructor.event.REMOVE,function(d){g.remove(d.file.sUrl)});
b.render();f.status=b.constructor.status;return b},_select:function(b){var g=this,d=g.get("autoUpload"),j=g.get("queue"),k=g.get("curUploadIndex"),o=b.files;c.each(o,function(m){if(!m.size)m.size=0;if(!m.name)m.name=m.fileName||"";m.input=b.input||m});g.fire(f.event.SELECT,{files:o});if(!g.get("isAllowUpload"))return false;j.add(o,function(){k==""&&d&&g.uploadFiles()})},_renderUrlsInput:function(){var b=this.get("button").target,g=this.get("urlsInputName");b=new i(b,{name:g});b.render();return b},
_uploadCompleteHanlder:function(b){b=b.result;var g,d=f.event,j=this.get("queue"),k=this.get("curUploadIndex");if(!c.isObject(b))return false;if(g=b.status){j.fileStatus(k,f.status.SUCCESS);this._success(b.data);this.fire(d.SUCCESS,{index:k,file:j.getFile(k)})}else{j.fileStatus(k,f.status.ERROR,b.msg||"");this.fire(d.ERROR,{status:g})}this.set("curUploadIndex","");this.fire(d.COMPLETE,{index:k,file:j.getFile(k)});this._continueUpload()},_uploadStopHanlder:function(){var b=this.get("queue"),g=this.get("curUploadIndex");
b.fileStatus(g,f.status.CANCEL);this.set("curUploadIndex","");this.fire(f.event.CANCEL,{index:g})},_continueUpload:function(){var b=this.get("uploadFilesStatus");b!=""&&this._uploaderStatusFile(b)},_uploadProgressHandler:function(b){var g=this.get("queue"),d=this.get("curUploadIndex"),j=g.getFile(d);c.mix(b,{file:j});g.fileStatus(d,f.status.PROGRESS,b);this.fire(f.event.PROGRESS,b)},_success:function(b){if(!c.isObject(b))return false;b=b.url;var g=this.get("urlsInput"),d=this.get("curUploadId"),j=
this.get("queue");if(!c.isString(b)||!c.isObject(g))return false;j.updateFile(d,{sUrl:b});g.add(b)}},{ATTRS:{button:{value:{}},queue:{value:{}},type:{value:f.type.AUTO},serverConfig:{value:{action:"",data:{},dataType:"json"}},isAllowUpload:{value:true},autoUpload:{value:true},urlsInputName:{value:""},curUploadIndex:{value:""},uploadType:{value:{}},urlsInput:{value:""},uploadFilesStatus:{value:""}}});c.convertByteSize=function(b){var g=-1;do{b/=1024;g++}while(b>99);return Math.max(b,0.1).toFixed(1)+
["kB","MB","GB","TB","PB","EB"][g]};return f},{requires:["base","node","./urlsInput","./type/iframe","./type/ajax","./type/flash","flash"]});
KISSY.add("form/uploader/button/base",function(c,n,l){function i(e,a){a=c.merge({target:h(e)},a);i.superclass.constructor.call(this,a)}var h=n.all;c.mix(i,{event:{beforeShow:"beforeShow",afterShow:"afterShow",beforeHide:"beforeHide",afterHide:"afterHide",beforeRender:"beforeRender",afterRender:"afterRender",CHANGE:"change"},getFileName:function(e){return e.replace(/.*(\/|\\)/,"")}});c.extend(i,l,{render:function(){var e=this.get("target");if(this.fire(i.event.beforeRender)===false){c.log("[AjaxUploader-Button] button render was prevented.");
return false}else{if(e==null){c.log("[AjaxUploader-Button] Cannot find target!");return false}this._createInput();this._setDisabled(this.get("disabled"));this._setMultiple(this.get("multiple"));this.fire(i.event.afterRender);return this}},show:function(){this.get("target").show();this.fire(i.event.afterShow);return i},hide:function(){this.get("target").hide();this.fire(i.event.afterHide);return i},reset:function(){var e=this.get("inputContainer");h(e).remove();this.set("inputContainer","");this.set("fileInput",
"");this._createInput();return this},_createInput:function(){var e=this.get("target"),a=this.get("name"),f=this.get("tpl");if(!c.isString(a)||!c.isString(f)){c.log("[AjaxUploader-Button] No name or tpl specified.");return false}a=c.substitute(f,{name:a});a=h(a);h(a).appendTo(e);e=h(a).children("input");h(e).on("change",this._changeHandler,this);this.set("fileInput",e);this.set("inputContainer",a);return a},_changeHandler:function(e){var a=this.get("fileInput"),f=h(a).val();e=e.target.files;var b=
[];if(f==""){c.log("[AjaxUploader-Button] No file selected.");return false}e?c.each(e,function(g){c.isObject(g)&&b.push({name:g.name,type:g.type,size:g.size})}):b.push({name:i.getFileName(f)});this.fire(i.event.CHANGE,{files:b,input:a.getDOMNode()});this.reset()},_setDisabled:function(e){var a=this.get("cls").disabled,f=this.get("target"),b=this.get("fileInput");if(!f.length||!c.isBoolean(e))return false;if(e){f.addClass(a);h(b).hide()}else{f.removeClass(a);h(b).show()}return e},_setMultiple:function(e){var a=
this.get("fileInput");if(!a.length)return false;e&&a.attr("multiple","multiple")||a.removeAttr("multiple");return e}},{ATTRS:{target:{value:null},fileInput:{value:""},inputContainer:{value:""},tpl:{value:'<div class="file-input-wrapper"><input type="file" name="{name}" hidefoucs="true" class="file-input" /></div>'},name:{value:"fileInput",setter:function(e){this.get("fileInput")&&h(this.get("fileInput")).attr("name",e);return e}},disabled:{value:false,setter:function(e){this._setDisabled(e);return e}},
multiple:{value:true,setter:function(e){this._setMultiple(e);return e}},cls:{value:{disabled:"uploader-button-disabled"}}}});return i},{requires:["node","base"]});
KISSY.add("form/uploader/button/swfButton",function(c,n,l,i){function h(a,f){f=c.merge({target:e(a)},f);h.superclass.constructor.call(this,f)}var e=n.all;c.mix(h,{event:{RENDER:"render",CHANGE:"change",MOUSE_OVER:"mouseOver",MOUSE_DOWN:"mouseDown",MOUSE_UP:"mouseUp",MOUSE_OUT:"mouseOut",CLICK:"click"}});c.extend(h,l,{render:function(){var a=this,f=a.get("target"),b,g=a.get("multiple"),d=a.get("fileFilters");f.css("position","relative");a.set("swfWrapper",a._createSwfWrapper());a._setFlashSizeConfig();
b=a._initSwfUploader();b.on("contentReady",function(){b.browse(g,d);a._bindBtnEvent();b.on("fileSelect",a._changeHandler,a);a._setDisabled(a.get("disabled"));a.fire(h.event.RENDER)},a)},_createSwfWrapper:function(){var a=this.get("target"),f=this.get("tpl"),b=this.get("swfWrapperId")!=""&&this.get("swfWrapperId")||"swf-uploader-wrapper-"+c.guid();f=c.substitute(f,{id:b});this.set("swfWrapperId",b);return e(f).appendTo(a)},_initSwfUploader:function(){var a=this.get("flash"),f=this.get("swfWrapperId"),
b;try{b=new i(f,a);this.set("swfUploader",b)}catch(g){}return b},_bindBtnEvent:function(){var a=this,f=h.event,b=a.get("swfUploader");if(!b)return false;c.each(f,function(g){b.on(g,function(){a.fire(g)},a)});return a},_setFlashSizeConfig:function(){var a=this.get("flash"),f=this.get("target");c.mix(a.attrs,{width:f.width(),height:f.height()});this.set("flash",a)},_changeHandler:function(a){this.fire(h.event.CHANGE,{files:a.fileList})},_setDisabled:function(a){var f=this.get("swfUploader"),b=this.get("cls").disabled,
g=this.get("target"),d=this.get("swfWrapper");if(!f||!c.isBoolean(a))return false;if(a){g.addClass(b);d.hide()}else{g.removeClass(b);d.show()}return a}},{ATTRS:{target:{value:""},swfWrapper:{value:""},swfWrapperId:{value:""},tpl:{value:'<div id="{id}" class="uploader-button-swf" style="position: absolute;top:0;left:0;"></div>'},multiple:{value:true,setter:function(a){var f=this.get("swfUploader");f&&f.multifile(a);return a}},fileFilters:{value:[],setter:function(a){var f=this.get("swfUploader");f&&
c.isArray(a)&&f.filter(a);return a}},disabled:{value:false,setter:function(a){this.get("swfUploader")&&this._setDisabled(a);return a}},cls:{value:{disabled:"uploader-button-disabled"}},flash:{value:{src:"../plugins/ajbridge/uploader.swf",id:"swfUploader",params:{bgcolor:"#fff",wmode:"transparent"},attrs:{},hand:true,btn:true}},swfUploader:{value:""}}});return h},{requires:["node","base","form/uploader/plugins/ajbridge/uploader"]});
KISSY.add("form/uploader/plugins/ajbridge/ajbridge",function(c,n){function l(f,b,g){f=f.replace(i,"");b=n._normalize(b||{});var d=this;f=i+f;var j=function(k){if(k.status<1)d.fire("failed",{data:k});else{c.mix(d,k);if(!k.dynamic||!b.src)d.activate()}};b.id=b.id||c.guid(h);l.instances[b.id]=d;if(b.src){b.params.allowscriptaccess="always";b.params.flashvars=c.merge(b.params.flashvars,{jsEntry:a,swfID:b.id})}if(g)d.__args=[f,b,j];else c.later(n.add,e,false,n,[f,b,j])}var i="#",h="ks-ajb-",e=100,a="KISSY.AJBridge.eventHandler";
c.app(l,{version:"1.0.15",instances:{},eventHandler:function(f,b){var g=l.instances[f];g&&g.__eventHandler(f,b)},augment:function(f,b){if(c.isString(b))b=[b];c.isArray(b)&&c.each(b,function(g){f.prototype[g]=function(){try{return this.callSWF(g,c.makeArray(arguments))}catch(d){this.fire("error",{message:d})}}})}});c.augment(l,c.EventTarget,{init:function(){if(this.__args){n.add.apply(n,this.__args);this.__args=null;delete this.__args}},__eventHandler:function(f,b){var g=b.type;b.id=f;switch(g){case "log":c.log(b.message);
break;default:this.fire(g,b)}},callSWF:function(f,b){b=b||[];try{if(this.swf[f])return this.swf[f].apply(this.swf,b)}catch(g){var d="";if(b.length!==0)d="'"+b.join("','")+"'";return(new Function("self","return self.swf."+f+"("+d+");"))(this)}}});l.augment(l,["activate","getReady","getCoreVersion"]);return window.AJBridge=c.AJBridge=l},{requires:["flash"]});
KISSY.add("form/uploader/plugins/ajbridge/uploader",function(c,n,l){function i(h,e){e=e||{};var a={};c.each(["ds","dsp","btn","hand"],function(f){if(f in e)a[f]=e[f]});e.params=e.params||{};e.params.flashvars=c.merge(e.params.flashvars,a);i.superclass.constructor.call(this,h,e)}c.extend(i,l);l.augment(i,["setFileFilters","filter","setAllowMultipleFiles","multifile","browse","upload","uploadAll","cancel","getFile","removeFile","lock","unlock","setBtnMode","useHand","clear"]);i.version="1.0.1";l.Uploader=
i;return l.Uploader},{requires:["flash","form/uploader/plugins/ajbridge/ajbridge"]});
KISSY.add(function(c){function n(h){var e={mode:"filter",maxWidth:40,maxHeight:40,onError:function(){return 1},preview:true,destroy:true};this.event={check:"check",show:"show",error:"error"};if(typeof window.FileReader==="undefined")switch(c.UA.shell){case "firefox":e.mode="domfile";break;case "ie":switch(c.UA.ie){case 6:e.mode="simple";break;default:e.mode="filter"}break;default:e.mode="simple";e.preview=false}else e.mode="html5";this.config=c.mix(e,h);c.log(i+"Preview initialized.")}var l=c.DOM,
i="[Plugin: Preview] ";c.augment(n,c.EventTarget,{preview:function(h,e){function a(){switch(d.config.mode){case "filter":d.file.select();k=g;try{return j.selection.createRange().text}catch(m){c.log("[UploadPreview] Get image data error, the error is: ");c.log(m,"dir")}finally{j.selection.empty()}break;case "domfile":k=b;return d.file.files[0].getAsDataURL();case "html5":var p=new FileReader;p.onload=function(q){f(q.target.result)};p.onerror=function(){c.log("[UploadPreview] File Reader Error. Your browser may not fully support html5 file api",
"warning")};p.readAsDataURL(d.file.files[0]);return false;case "remote":k=remotePreview;c.log("[UploadPreview] This function is not supported right now.");break;default:k=b;return d.file.value}}function f(m,p,q){d.img.src=m;if(p>1&&q>1){var r=Math.min(1,Math.max(0,d.config.maxWidth)/p||1,Math.max(0,d.config.maxHeight)/q||1);d.img.style.width=Math.round(p*r)+"px";d.img.style.height=Math.round(q*r)+"px";d.img.setAttribute("data-ratio",r)}l.attr(d.img,"data-ks-imagezoom",d.config.mode=="filter"?d.data:
m);d.fire(d.event.show)}function b(){f(d.data)}function g(){if(!d.preload){d.preload=document.createElement("div");l.css(d.preload,{visibility:"hidden",position:"absolute",left:"-9999px",top:"-9999px",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='image')"});var m=document.body;m.insertBefore(d.preload,m.childNodes[0]);m=null}d.data=d.data.replace(/[)'"%]/g,function(q){return escape(escape(q))});c.log("[UploadPreview] This escaped data is "+d.data);try{d.preload.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=
d.data}catch(p){d._error("[UploadPreview] Filter error")}d.img.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src=\""+d.data+'")';d.img.zoom=1;d.img.setAttribute("data-ks-imagezoom",d.data);f(d.TRANSPARENT,d.preload.offsetWidth,d.preload.offsetHeight)}var d=this,j=document,k;d.file=h;d.img=e;d.preload=null;d.data=null;d.TRANSPARENT=c.UA.ie==6||c.UA.ie==7?"http://a.tbcdn.cn/p/fp/2011a/assets/space.gif":"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
if(d.file){c.log("[UploadPreview] One file selected. Using "+d.config.mode+" mode to preview.");if(d.fire(d.event.check)!==false){var o=a();c.log("[UploadPreview] Get data done. The data is "+o);if(o&&o!==d.data){d.data=o;o=null;k()}}else c.log("[UploadPreview] Check error.")}},setConfig:function(h){self.config=c.mix(self.config,h)},destroy:function(){if(this._upload){this._upload.dispose();this._upload=null}this.file=this.img=this.data=this.preload=null},_error:function(h){c.log(h)}});return n});
KISSY.add("form/uploader/preview/preview",function(c){function n(h){var e={mode:"filter",maxWidth:40,maxHeight:40,onError:function(){return 1},preview:true,destroy:true};this.event={check:"check",show:"show",error:"error"};if(typeof window.FileReader==="undefined")switch(c.UA.shell){case "firefox":e.mode="domfile";break;case "ie":switch(c.UA.ie){case 6:e.mode="simple";break;default:e.mode="filter"}break;default:e.mode="simple";e.preview=false}else e.mode="html5";this.config=c.mix(e,h);c.log(i+"Preview initialized.")}
var l=c.DOM,i="[Plugin: Preview] ";c.augment(n,c.EventTarget,{preview:function(h,e){function a(){switch(d.config.mode){case "filter":d.file.select();k=g;try{return j.selection.createRange().text}catch(m){c.log("[UploadPreview] Get image data error, the error is: ");c.log(m,"dir")}finally{j.selection.empty()}break;case "domfile":k=b;return d.file.files[0].getAsDataURL();case "html5":var p=new FileReader;p.onload=function(q){f(q.target.result)};p.onerror=function(){c.log("[UploadPreview] File Reader Error. Your browser may not fully support html5 file api",
"warning")};p.readAsDataURL(d.file.files[0]);return false;case "remote":k=remotePreview;c.log("[UploadPreview] This function is not supported right now.");break;default:k=b;return d.file.value}}function f(m,p,q){d.img.src=m;if(p>1&&q>1){var r=Math.min(1,Math.max(0,d.config.maxWidth)/p||1,Math.max(0,d.config.maxHeight)/q||1);d.img.style.width=Math.round(p*r)+"px";d.img.style.height=Math.round(q*r)+"px";d.img.setAttribute("data-ratio",r)}l.attr(d.img,"data-ks-imagezoom",d.config.mode=="filter"?d.data:
m);d.fire(d.event.show)}function b(){f(d.data)}function g(){if(!d.preload){d.preload=document.createElement("div");l.css(d.preload,{visibility:"hidden",position:"absolute",left:"-9999px",top:"-9999px",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='image')"});var m=document.body;m.insertBefore(d.preload,m.childNodes[0]);m=null}d.data=d.data.replace(/[)'"%]/g,function(q){return escape(escape(q))});c.log("[UploadPreview] This escaped data is "+d.data);try{d.preload.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=
d.data}catch(p){d._error("[UploadPreview] Filter error")}d.img.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src=\""+d.data+'")';d.img.zoom=1;d.img.setAttribute("data-ks-imagezoom",d.data);f(d.TRANSPARENT,d.preload.offsetWidth,d.preload.offsetHeight)}var d=this,j=document,k;d.file=h;d.img=e;d.preload=null;d.data=null;d.TRANSPARENT=c.UA.ie==6||c.UA.ie==7?"http://a.tbcdn.cn/p/fp/2011a/assets/space.gif":"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
if(d.file){c.log("[UploadPreview] One file selected. Using "+d.config.mode+" mode to preview.");if(d.fire(d.event.check)!==false){var o=a();c.log("[UploadPreview] Get data done. The data is "+o);if(o&&o!==d.data){d.data=o;o=null;k()}}else c.log("[UploadPreview] Check error.")}},setConfig:function(h){self.config=c.mix(self.config,h)},destroy:function(){if(this._upload){this._upload.dispose();this._upload=null}this.file=this.img=this.data=this.preload=null},_error:function(h){c.log(h)}});return n});
KISSY.add("form/uploader/plugins/progressBar/progressBar",function(c,n,l){function i(e,a){a=c.merge({wrapper:h(e)},a);i.superclass.constructor.call(this,a)}var h=n.all;c.mix(i,{tpl:{DEFAULT:'<div class="ks-progress-bar-value" data-value="{value}"></div>'},cls:{PROGRESS_BAR:"ks-progress-bar",VALUE:"ks-progress-bar-value"},event:{RENDER:"render",CHANGE:"change",SHOW:"show",HIDE:"hide"}});c.extend(i,l,{render:function(){var e=this.get("wrapper"),a=this.get("width");if(!e.length)return false;e.addClass(i.cls.PROGRESS_BAR).width(a);
this._addAttr();!this.get("visible")&&this.hide();this.set("bar",this._create());this.fire(i.event.RENDER)},show:function(){var e=this;e.get("wrapper").fadeIn(e.get("duration"),function(){e.set("visible",true);e.fire(i.event.SHOW,{visible:true})})},hide:function(){var e=this;e.get("wrapper").fadeOut(e.get("duration"),function(){e.set("visible",false);e.fire(i.event.HIDE,{visible:false})})},_create:function(){var e=this.get("wrapper"),a=this.get("value"),f=this.get("tpl");a=c.substitute(f,{value:a});
e.html("");return h(a).appendTo(e)},_addAttr:function(){var e=this.get("wrapper"),a=this.get("value");e.attr("role","progressbar");e.attr("aria-valuemin",0);e.attr("aria-valuemax",100);e.attr("aria-valuenow",a);return this}},{ATTRS:{wrapper:{value:""},bar:{value:""},width:{value:100},value:{value:0,setter:function(e){var a=this,f=a.get("wrapper"),b=a.get("bar"),g=a.get("speed"),d;if(e>100)e=100;if(e<0)e=0;d=f.width()*(e/100);b.animate({width:d+"px"},g,"none",function(){f.attr("aria-valuenow",e);b.attr("data-value",
e);a.fire(i.event.CHANGE,{value:e,width:d})});return e}},visible:{value:true},duration:{value:0.3},tpl:{value:i.tpl.DEFAULT},speed:{value:0.2}}});return i},{requires:["node","base"]});
KISSY.add("form/uploader/queue/base",function(c,n,l,i){function h(a,f){h.superclass.constructor.call(this,f);this.set("target",e(a))}var e=n.all;c.mix(h,{tpl:{DEFAULT:'<li id="queue-file-{id}" class="clearfix" data-name="{name}"><div class="f-l sprite file-icon"></div><div class="f-l">{name}</div><div class="f-l file-status J_FileStatus"></div></li>'},event:{RENDER:"render",ADD:"add",ADD_FILES:"addFiles",REMOVE:"remove",CLEAR:"clear",FILE_STATUS:"fileStatus",UPDATE_FILE:"updateFile"},status:i.type,
cls:{QUEUE:"ks-uploader-queue"},hook:{STATUS:".J_FileStatus"},FILE_ID_PREFIX:"file-"});c.extend(h,l,{render:function(){this.get("target").addClass(h.cls.QUEUE);this.fire(h.event.RENDER);return this},add:function(a,f){var b=this,g=h.event;if(a.length>0){b._addFiles(a,function(){f&&f.call(b);b.fire(g.ADD_FILES,{files:a})});return false}else return b._addFile(a,function(d,j){f&&f.call(b,d,j)})},_addFile:function(a,f){if(!c.isObject(a)){c.log("[uploader-queue]:_addFile()参数file不合法！");return false}var b=
this,g=b.get("duration"),d=b._setAddFileData(a),j=b.getFileIndex(d.id);b.fileStatus(j,h.status.WAITING);d.target.fadeIn(g,function(){b.fire(h.event.ADD,{index:j,file:d,target:d.target});f&&f.call(b,j,d)});return d},_addFiles:function(a,f){function b(d){if(d===a.length){f&&f.call(this);return false}g._addFile(a[d],function(){d++;b(d)})}if(!a.length){c.log("[uploader-queue]:_addFiles()参数files不合法！");return false}var g=this;b(0)},remove:function(a,f){var b=this,g=b.get("files"),d,j,k=b.get("duration");
if(c.isString(a))a=b.getFileIndex(a);d=g[a];if(!c.isObject(d)){c.log("[uploader-queue]:remove()不存在index为"+a+"的文件数据");return false}j=d.target;j.fadeOut(k,function(){j.remove();b.fire(h.event.REMOVE,{index:a,file:d});f&&f.call(b,a,d)});g=c.filter(g,function(o,m){return m!==a});b.set("files",g);return d},clear:function(){function a(){b=f.get("files");if(!b.length){f.fire(h.event.CLEAR);return false}f.remove(0,function(){a()})}var f=this,b;a()},fileStatus:function(a,f,b){if(!c.isNumber(a))return false;
var g=this.getFile(a);if(!c.isPlainObject(g))return false;g=g.status;f&&g.change(f,b);this.fire(h.event.FILE_STATUS,{index:a,status:f});return g},getFile:function(a){if(!c.isNumber(a))return false;a=this.get("files")[a];c.isPlainObject(a)||(a=false);return a},getFileIndex:function(a){var f=this.get("files"),b=-1;c.each(f,function(g,d){if(g.id==a){b=d;return true}});return b},updateFile:function(a,f){if(!c.isNumber(a))return false;if(!c.isObject(f)){c.log("[uploader-queue]:updateFile()的data参数有误！");
return false}var b=this.get("files"),g=this.getFile(a);if(!g)return false;c.mix(g,f);b[a]=g;this.set("files",b);this.fire(h.event.UPDATE_FILE,{index:a,file:g});return g},getIndexs:function(a){var f=this.get("files"),b,g=[];if(!f.length)return g;c.each(f,function(d,j){if(c.isObject(d)){b=d.status;b.get("curType")==a&&g.push(j)}});return g},getFiles:function(a){var f=this.get("files"),b,g=[];if(!f.length)return false;c.each(f,function(d){if(d){b=d.status;b.get("curType")==a&&g.push(d)}});return g},
_setAddFileData:function(a){var f=this.get("files"),b=this.get("uploader");if(!c.isObject(a)){c.log("[uploader-queue]:_updateFileData()参数file不合法！");return false}if(!a.id)a.id=c.guid(h.FILE_ID_PREFIX);if(a.size)a.textSize=i.convertByteSize(a.size);a.target=this._appendFileHtml(a);a.status=this._renderStatus(a);c.isObject(b)&&a.status.set("uploader",b);f.push(a);return a},_appendFileHtml:function(a){var f=this.get("target"),b=this.get("tpl");b=c.substitute(b,a);return e(b).hide().appendTo(f).data("data-file",
a)},_renderStatus:function(a){var f=a.target,b=h.hook.STATUS,g=this.get("statusConfig");if(!f.length)return false;f=f.children(b);c.mix(g,{queue:this,file:a});return new i(f,g)}},{ATTRS:{tpl:{value:h.tpl.DEFAULT},duration:{value:0.3},target:{value:""},files:{value:[]},statusConfig:{value:{}},uploader:{value:""}}});return h},{requires:["node","base","./status"]});
KISSY.add("form/uploader/queue/status",function(c,n,l,i){function h(a,f){f=c.merge({target:e(a)},f);h.superclass.constructor.call(this,f)}var e=n.all;c.mix(h,{type:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error"},convertByteSize:function(a){var f=-1;do{a/=1024;f++}while(a>99);return Math.max(a,0.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][f]}});c.extend(h,l,{change:function(a,f){if(!c.isString(a))return false;var b;if(!this.isSupport(a)){c.log("[queue-status]:status参数为"+
a+"，不支持的状态类型");return false}f||(f={});(b=this["_"+a])&&b.call(this,f);this.set("curType",a);return this},isSupport:function(a){if(!c.isString(a))return false;var f=false;c.each(h.type,function(b){if(a==b)return f=true});return f},_changeDom:function(a){var f=this.get("target");f.html("");return e(a).appendTo(f)},_waiting:function(){var a=this.get("tpl").waiting,f=this.get("uploader"),b=this.get("queue"),g=this.get("file").id,d=b.getFileIndex(g);this._changeDom(a).children(".J_Upload").on("click",
function(j){j.preventDefault();if(!c.isObject(f))return false;f.upload(d)})},_start:function(){var a=this.get("tpl").start,f=this.get("target"),b=this.get("uploader"),g=b.get("type");if(!c.isString(a))return false;a=this._changeDom(a);a.children(".J_UploadCancel").on("click",function(d){d.preventDefault();if(!c.isObject(b))return false;b.cancel()});if(g=="ajax"||g=="flash"){g=a.children(".J_ProgressBar");g=new i(g);g.render();this.set("progressBar",g)}f.parent().addClass("current-upload-file")},_progress:function(a){a=
Math.ceil(a.loaded/a.total)*100;var f=this.get("progressBar");if(!f)return false;f.set("value",a)},_success:function(){var a=this,f=a.get("tpl").success,b=a.get("target"),g=a.get("queue"),d=a.get("file").id,j=a.get("progressBar"),k=a.get("target"),o,m,p;if(!c.isString(f))return false;c.isObject(j)&&j.set("value",100);c.later(function(){if(c.isObject(j))m=k.children().children(".J_ProgressBar").clone(true);o=a._changeDom(f);m&&o.prepend(m);p=o.children(".J_FileDel");p.on("click",function(q){q.preventDefault();
g.remove(d)})},300);b.parent().removeClass("current-upload-file")},_cancel:function(){var a=this.get("tpl").cancel,f=this.get("uploader");a=this._changeDom(a).children(".J_ReUpload");var b=this.get("file").id;a.on("click",function(g){g.preventDefault();if(!c.isObject(f))return false;f.upload(b)})},_error:function(a){c.isObject(a)||(a={msg:"文件上传失败！"});var f=this.get("tpl").error;a=this._changeDom(c.substitute(f,a)).children(".J_FileDel");var b=this.get("queue"),g=this.get("file").id;a.on("click",function(d){d.preventDefault();
b.remove(g)})}},{ATTRS:{target:{value:""},tpl:{value:{waiting:'<div class="waiting-status">等待上传，<a href="#Upload" class="J_Upload">点此上传</a> </div>',start:'<div class="start-status clearfix"><div class="f-l  J_ProgressBar uploader-progress"><img class="loading" src="http://img01.taobaocdn.com/tps/i1/T1F5tVXjRfXXXXXXXX-16-16.gif" alt="loading" /></div> <a class="f-l J_UploadCancel upload-cancel" href="#uploadCancel">取消</a></div> ',success:' <div class="success-status"><a href="#fileDel" class="J_FileDel">删除</a></div>',
cancel:'<div class="cancel-status">已经取消上传，<a href="#reUpload" class="J_ReUpload">点此重新上传</a> </div>',error:'<div class="error-status upload-error">{msg}<a href="#fileDel" class="J_FileDel">点此删除</a></div>'}},queue:{value:""},uploader:{value:""},file:{value:{}},curType:{value:""},progressBar:{value:""}}});return h},{requires:["node","base","../plugins/progressBar/progressBar"]});
KISSY.add("form/uploader/render",function(c,n,l,i,h,e,a){function f(d,j,k){k=c.mix(c.parseConfig(d),k);f.superclass.constructor.call(this,k);this.set("buttonTarget",d);this.set("queueTarget",j);this.set("uploaderConfig",k);this._init()}var b=l.all,g={CONFIG:"data-config",BUTTON_CONFIG:"data-button-config",THEME_CONFIG:"data-theme-config",AUTH:"data-auth"};c.parseConfig=function(d,j){var k={},o,m=j||g.CONFIG;o=b(d).attr(m);if(!c.isString(o))return{};try{k=c.JSON.parse(o)}catch(p){c.log("[uploaderRender]:请检查"+
d+"上"+m+"属性内的json格式是否符合规范！")}return k};c.extend(f,n,{_init:function(){var d=this,j=d.get("uploaderConfig"),k=d._initButton(),o;d.set("button",k);d._initThemes(function(m){o=m.get("queue");c.mix(j,{button:k,queue:o});var p=new i(j);p.render();d.set("uploader",p);m.afterUploaderRender&&m.afterUploaderRender(p);d._auth();d.fire("init",{uploader:p})})},_initButton:function(){var d=this.get("buttonTarget"),j=c.parseConfig(d,g.BUTTON_CONFIG),k=this.get("name"),o=this.get("type");j=c.merge({name:k},j);return o!=
"flash"&&new h(d,j)||new e(d)},_initThemes:function(d){var j=this,k=j.get("theme"),o=j.get("buttonTarget"),m=c.parseConfig(o,g.THEME_CONFIG);c.use(k+"/index",function(p,q){var r=j.get("queueTarget");p.mix(m,{queueTarget:r});r=new q(m);d&&d.call(j,r)})},_auth:function(){var d=this.get("buttonTarget"),j=this.get("uploader");if(b(d).attr(g.AUTH)){d=c.parseConfig(d,g.AUTH);j=new a(j,{rules:d});this.set("auth",j)}}},{ATTRS:{theme:{value:"form/uploader/themes/default"},buttonTarget:{value:""},queueTarget:{value:""},
uploaderConfig:{},button:{value:""},queue:{value:""},uploader:{value:""},auth:{value:""}}});return f},{requires:["base","node","./base","./button/base","./button/swfButton","./auth/base"]});
KISSY.add("form/uploader/type/ajax",function(c,n,l){function i(e){i.superclass.constructor.call(this,e);try{this.set("formData",new FormData)}catch(a){}this._processData()}var h=n.all;c.mix(i,{event:c.merge(l.event,{PROGRESS:"progress"})});c.extend(i,l,{upload:function(e){if(!e){c.log("[uploader-AjaxType]:upload()，fileInput参数有误！");return false}var a=e.files;if(!a.length){c.log("[uploader-AjaxType]:upload()，不存在要上传的文件！");return false}this._addFileData(e,a[0]);this.send();return this},stop:function(){var e=
this.get("xhr");if(!c.isObject(e)){c.log("[uploader-AjaxType]:stop()，io值错误！");return false}e.abort();this.fire(i.event.STOP);return this},send:function(){var e=this,a=e.get("action"),f=e.get("formData"),b=new XMLHttpRequest;b.upload.addEventListener("progress",function(g){e.fire(i.event.PROGRESS,{loaded:g.loaded,total:g.total})});b.onload=function(){var g={};try{g=c.JSON.parse(b.responseText)}catch(d){c.log("[uploader-AjaxType]:ajax返回结果集responseText格式不合法！")}e.fire(i.event.SUCCESS,{result:g})};b.open("POST",
a,true);b.send(f);e.set("xhr",b);return e},_processData:function(){var e=this.get("data"),a=this.get("formData");c.each(e,function(f,b){a.append(b,f)});this.set("formData",a)},_addFileData:function(e,a){if(!c.isObject(a)){c.log("[uploader-AjaxType]:_addFileData()，file参数有误！");return false}var f=this.get("formData"),b=this.get("fileDataName");if(b==""){b=h(e).attr("name");this.set("fileDataName",b)}f.append(b,a);this.set("formData",f)}},{ATTRS:{formData:{value:""},ajaxConfig:{value:{type:"post",processData:false,
cache:false,dataType:"json",contentType:false}},xhr:{value:""},fileDataName:{value:""},form:{value:{}},fileInput:{value:""}}});return i},{requires:["node","./base"]});KISSY.add("form/uploader/type/base",function(c,n,l){function i(h){i.superclass.constructor.call(this,h)}c.mix(i,{event:{START:"start",STOP:"stop",SUCCESS:"success",ERROR:"error"}});c.extend(i,l,{upload:function(){},stop:function(){}},{ATTRS:{action:{value:""},data:{value:{}}}});return i},{requires:["node","base"]});
KISSY.add("form/uploader/type/flash",function(c,n,l){function i(h){i.superclass.constructor.call(this,h);this._init()}c.mix(i,{event:c.merge(l.event,{SWF_READY:"swfReady",PROGRESS:"progress"})});c.extend(i,l,{_init:function(){var h=this,e=h.get("swfUploader");if(!e){c.log("[uploader-FlashType]:swfUploader对象为空！");return false}e.on("contentReady",function(){h.fire(i.event.SWF_READY)},h);e.on("uploadStart",h._uploadStartHandler,h);e.on("uploadProgress",h._uploadProgressHandler,h);e.on("uploadCompleteData",
h._uploadCompleteDataHandler,h);e.on("uploadError",h._uploadErrorHandler,h)},upload:function(h){var e=this.get("swfUploader"),a=this.get("action"),f=this.get("data");this.set("uploadingId",h);e.upload(h,a,"POST",f);return this},stop:function(){var h=this.get("swfUploader"),e=this.get("uploadingId");if(e!=""){h.cancel(e);this.fire(i.event.STOP,{id:e})}return this},_uploadStartHandler:function(h){this.fire(i.event.START,{file:h.file})},_uploadProgressHandler:function(h){c.mix(h,{loaded:h.bytesLoaded,
total:h.bytesTotal});this.fire(i.event.PROGRESS,{loaded:h.loaded,total:h.total})},_uploadCompleteDataHandler:function(h){var e;try{e=JSON.parse(h.data)}catch(a){c.log("[uploader-FlashType]:json数据格式不合法！");this.fire(i.event.ERROR,{msg:"不是合法的json数据"})}this.set("uploadingId","");this.fire(i.event.SUCCESS,{result:e})},_uploadErrorHandler:function(h){this.set("uploadingId","");this.fire(i.event.ERROR,{msg:h.msg})}},{ATTRS:{swfUploader:{value:""},uploadingId:{value:""}}});return i},{requires:["node","./base"]});
KISSY.add("form/uploader/type/iframe",function(c,n,l){function i(e){i.superclass.constructor.call(this,e)}var h=n.all;c.mix(i,{tpl:{IFRAME:'<iframe src="javascript:false;" name="{id}" id="{id}" border="no" width="1" height="1" style="display: none;" />',FORM:'<form method="post" enctype="multipart/form-data" action="{action}" target="{target}">{hiddenInputs}</form>',HIDDEN_INPUT:'<input type="hidden" name="{name}" value="{value}" />'},event:c.mix(l.event,{CREATE:"create",REMOVE:"remove"})});c.extend(i,
l,{upload:function(e){e=h(e);if(!e.length)return false;this.fire(i.event.START,{input:e});this.set("fileInput",e);this._create();this.get("form").getDOMNode().submit()},stop:function(){this.get("iframe").attr("src",'javascript:"<html></html>";');this.fire(i.event.STOP);this.fire(i.event.ERROR,{status:"abort",msg:"上传失败，原因：abort"});return this},dataToHidden:function(e){if(!c.isObject(e)||c.isEmptyObject(e)){c.log("[uploader-iframeType]:data参数不是对象或者为空！");return false}var a="",f=this.get("tpl").HIDDEN_INPUT;
if(!c.isString(f))return false;for(var b in e)a+=c.substitute(f,{name:b,value:e[b]});return a},_createIframe:function(){var e=this.get("id"),a=this.get("tpl"),f=a.IFRAME,b=this.get("iframe");if(!c.isEmptyObject(b))return b;if(!c.isString(f)){c.log("[uploader-iframeType]:iframe的模板不合法！");return false}if(!c.isString(e)){c.log("[uploader-iframeType]:id必须存在且为字符串类型！");return false}e=c.substitute(a.IFRAME,{id:e});e=h(e);e.on("load",this._iframeLoadHandler,this);h("body").append(e);this.set("iframe",e);return e},
_iframeLoadHandler:function(e){var a=e.target;e=i.event.ERROR;a=a.contentDocument||window.frames[a.id].document;if(!a||!a.body){this.fire(e,{msg:"服务器端返回数据有问题！"});return false}a=a.body.innerHTML;c.log("[uploader-iframeType]:服务器端输出:"+a);if(a=="")return false;try{a=JSON.parse(a)}catch(f){c.log("[uploader-iframeType]:json数据格式不合法！");this.fire(e,{msg:"数据："+a+"不是合法的json数据"})}this.fire(i.event.SUCCESS,{result:a});this._remove()},_createForm:function(){var e=this.get("id"),a=this.get("tpl").FORM,f=this.get("data"),
b=this.get("action"),g=this.get("fileInput"),d="";if(!c.isString(a)){c.log("[uploader-iframeType]:form模板不合法！");return false}if(!c.isObject(f)){c.log("[uploader-iframeType]:data参数不合法！");return false}if(!c.isString(b)){c.log("[uploader-iframeType]:action参数不合法！");return false}f=this.dataToHidden(f);if(f=="")return false;d=c.substitute(a,{action:b,target:e,hiddenInputs:f});e=h(d).append(g);h("body").append(e);this.set("form",e);return e},_create:function(){var e=this._createIframe(),a=this._createForm();
this.fire(i.event.CREATE,{iframe:e,form:a})},_remove:function(){var e=this.get("form");this.get("iframe");e.remove();this.reset("form");this.fire(i.event.REMOVE,{form:e})}},{ATTRS:{tpl:{value:i.tpl},id:{value:"ks-uploader-iframe-"+c.guid()},iframe:{value:{}},form:{value:{}},fileInput:{value:""}}});return i},{requires:["node","./base"]});
KISSY.add("form/uploader/urlsInput",function(c,n,l){function i(e,a){i.superclass.constructor.call(this,a);this.set("wrapper",h(e))}var h=n.all;c.mix(i,{TPL:'<input type="hidden" id="{name}" name="{name}" value="{value}" />'});c.extend(i,l,{render:function(){var e=this.get("wrapper"),a=this.get("name");a=document.getElementsByName(a)[0];if(!c.isObject(e)){c.log("[uploader-urlsInput]:container参数不合法！");return false}a?this.set("input",h(a)):this._create()},add:function(e){if(!c.isString(e)){c.log("[uploader-urlsInput]:add()的url参数不合法！");
return false}var a=this.get("urls");if(this.isExist(e)){c.log("[uploader-urlsInput]:add()，文件路径已经存在！");return this}a.push(e);this.set("urls",a);this._val();return this},remove:function(e){var a=this.get("urls");if(!this.isExist(e)){c.log("[uploader-urlsInput]:remove()，不存在该文件路径！");return false}a=c.filter(a,function(f){return f!=e});this.set("urls",a);this._val();return a},_val:function(){var e=this.get("urls"),a=this.get("input"),f=this.get("split");e=e.join(f);a.val(e);return e},isExist:function(e){var a=
false,f=this.get("urls");if(!f.length)return false;c.each(f,function(b){if(b==e)return a=true});return a},_create:function(){var e=this.get("wrapper"),a=this.get("tpl"),f=this.get("name"),b=this.get("urls");if(!c.isString(a)||!c.isString("name")){c.log("[uploader-urlsInput]:_create()，tpl和name属性不合法！");return false}a=h(c.substitute(a,{name:f,value:b}));e.append(a);this.set("input",a);return a}},{ATTRS:{name:{value:""},urls:{value:[]},tpl:{value:i.TPL},split:{value:",",setter:function(e){this._val();
return e}},input:{value:""},wrapper:{value:""}}});return i},{requires:["node","base"]});
