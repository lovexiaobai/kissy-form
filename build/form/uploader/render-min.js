KISSY.add("form/uploader/base",function(e,m,k,i,g,c,a){function d(b){d.superclass.constructor.call(this,b)}e.mix(d,{type:{AUTO:"auto",IFRAME:"iframe",AJAX:"ajax",FLASH:"flash"},event:{RENDER:"render",SELECT:"select",START:"start",COMPLETE:"complete",SUCCESS:"success",UPLOAD_ALL:"uploadAll",ERROR:"error"}});e.extend(d,m,{render:function(){var b=this.get("serverConfig"),f=this.getUploadType(this.get("type")),h=f.event,j;if(!f)return false;this.set("urlsInput",this._renderUrlsInput());this._renderQueue();
j=this._renderButton();this.get("type")==d.type.FLASH&&e.mix(b,{swfUploader:j.get("swfUploader")});b=new f(b);b.on(h.SUCCESS,this._uploadCompleteHanlder,this);h.PROGRESS&&b.on(h.PROGRESS,this._uploadProgressHandler,this);b.on(h.STOP,this._uploadStopHanlder,this);this.set("uploadType",b);this.fire(d.event.RENDER);return this},upload:function(b){if(!e.isNumber(b))return false;var f=this.get("uploadType"),h=this.get("queue"),j=h.get("files")[b],l;if(!e.isPlainObject(j)){e.log("[uploader]:队列中不存在id为"+
b+"的文件");return false}if(this.get("curUploadIndex")!=""){alert("第"+this.get("curUploadIndex")+"文件正在上传，请上传完后再操作！");return false}l=j.input.id||j.input;this.fire(d.event.START,{index:b,file:j});if(!this.get("isAllowUpload"))return false;this.set("curUploadIndex",b);h.fileStatus(b,h.constructor.status.START);f.upload(l)},cancel:function(){this.get("uploadType").stop();return this},uploadAll:function(){this.set("isUploadWaitFiles",true);this.uploadWaitFile()},uploadWaitFile:function(){var b=this.get("queue").getIndexs("waiting");
if(!b.length){this.set("isUploadWaitFiles",false);this.fire(d.event.UPLOAD_ALL);return false}this.upload(b[0])},isSupportAjax:function(){return e.isObject(FormData)},isSupportFlash:function(){var b=e.UA.fpv();return e.isArray(b)&&b.length>0},getUploadType:function(b){var f=this,h=d.type,j;if(b==h.AUTO)b=[h.AJAX,h.IFRAME];if(e.isArray(b)&&b.length>0)e.each(b,function(l){if(j=f._getType(l))return false});else j=f._getType(b);return j},_getType:function(b){var f=d.type,h=this.isSupportAjax(),j=this.isSupportFlash();
switch(b){case f.IFRAME:f=g;break;case f.AJAX:f=h&&c||false;break;case f.FLASH:f=j&&a||false;break;default:e.log("[uploader]:type参数不合法");return false}this.set("type",b);return f},_renderButton:function(){var b=this.get("button");if(!e.isObject(b)){e.log("[uploader]:button参数不合法！");return false}b.on("change",this._select,this);b.render();return b},_renderQueue:function(){var b=this.get("queue"),f=this.get("urlsInput");if(!e.isObject(b)){e.log("[uploader]:queue参数不合法");return false}b.set("uploader",this);
b.on(b.constructor.event.REMOVE,function(h){f.remove(h.file.sUrl)});b.render();return b},_select:function(b){var f=this,h=f.get("autoUpload"),j=f.get("queue"),l=f.get("curUploadIndex"),n=b.files;e.each(n,function(o){if(!o.size)o.size=0;if(!o.name)o.name=o.fileName||"";o.input=b.input||o});f.fire(d.event.SELECT,n);if(!f.get("isAllowUpload"))return false;j.add(n,function(){l==""&&h&&f.uploadAll()})},_renderUrlsInput:function(){var b=this.get("button").target,f=this.get("urlsInputName");b=new i(b,{name:f});
b.render();return b},_uploadCompleteHanlder:function(b){b=b.result;var f,h=d.event,j=this.get("queue"),l=this.get("curUploadIndex");if(!e.isObject(b))return false;if(f=b.status){j.fileStatus(l,j.constructor.status.SUCCESS);this._success(b.data);this.fire(h.SUCCESS)}else{j.fileStatus(l,j.constructor.status.ERROR);this.fire(h.ERROR,{status:f})}this.set("curUploadIndex","");this.fire(h.COMPLETE);this.get("isUploadWaitFiles")&&this.uploadWaitFile()},_uploadStopHanlder:function(){var b=this.get("queue"),
f=this.get("curUploadIndex");b.fileStatus(f,b.constructor.status.CANCEL);this.set("curUploadIndex","")},_uploadProgressHandler:function(b){var f=this.get("queue"),h=this.get("curUploadIndex");f.fileStatus(h,f.constructor.status.PROGRESS,b)},_success:function(b){if(!e.isObject(b))return false;b=b.url;var f=this.get("urlsInput"),h=this.get("curUploadId"),j=this.get("queue");if(!e.isString(b)||!e.isObject(f))return false;j.updateFile(h,{sUrl:b});f.add(b)},_error:function(){}},{ATTRS:{button:{value:{}},
queue:{value:{}},type:{value:d.type.AUTO},serverConfig:{value:{action:"",data:{},dataType:"json"}},isAllowUpload:{value:true},autoUpload:{value:true},urlsInputName:{value:""},curUploadIndex:{value:""},uploadType:{value:{}},urlsInput:{value:""},isUploadWaitFiles:{value:false}}});return d},{requires:["base","node","./urlsInput","./type/iframe","./type/ajax","./type/flash","flash"]});
KISSY.add("form/uploader/button/base",function(e,m,k){function i(c,a){a=e.merge({target:g(c)},a);i.superclass.constructor.call(this,a)}var g=m.all;e.mix(i,{event:{beforeShow:"beforeShow",afterShow:"afterShow",beforeHide:"beforeHide",afterHide:"afterHide",beforeRender:"beforeRender",afterRender:"afterRender",CHANGE:"change"}});e.extend(i,k,{render:function(){var c=this.get("target");if(this.fire(i.event.beforeRender)===false){e.log("[AjaxUploader-Button] button render was prevented.");return false}else{if(c==
null){e.log("[AjaxUploader-Button] Cannot find target!");return false}this._createInput();this.fire(i.event.afterRender);e.log("[AjaxUploader-Button] button was rendered just now.");return this}},show:function(){var c=this.get("target"),a=this.get("cls").disabled,d=this.get("fileInput");if(this.fire(i.event.beforeShow)===false)e.log("[AjaxUploader-Button] show button event was prevented.");else{g(c).removeClass(a);g(d).show();this.fire(i.event.afterShow);e.log("[AjaxUploader-Button] button showed.")}},
hide:function(){var c=this.get("target"),a=this.get("cls").disabled,d=this.get("fileInput");if(this.fire(i.event.beforeHide)===false)e.log("[AjaxUploader-Button] hide button event was prevented.");else{g(c).addClass(a);g(d).hide();this.fire(i.event.afterHide);e.log("[AjaxUploader-Button] button showed.")}},_reset:function(){var c=this.get("inputContainer");g(c).remove();this.set("inputContainer","");this.set("fileInput","");this._createInput();return this},_createInput:function(){var c=this.get("target"),
a=this.get("name"),d=this.get("tpl"),b=this.get("multiple");if(!e.isString(a)||!e.isString(d)){e.log("[AjaxUploader-Button] No name or tpl specified.");return false}a=e.substitute(d,{name:a});a=g(a);g(a).appendTo(c);c=g(a).children("input");b&&c.attr("multiple",b)||c.removeAttr("multiple");g(c).on("change",this._changeHandler,this);this.set("fileInput",c);this.set("inputContainer",a);return a},_changeHandler:function(c){var a=this.get("fileInput"),d=g(a).val();c=c.target.files;var b=[];if(d==""){e.log("[AjaxUploader-Button] No file selected.");
return false}e.each(c,function(f){e.isObject(f)&&b.push({name:f.name,type:f.type,size:f.size})});this.fire(i.event.CHANGE,{files:b,input:g(a).clone().getDOMNode()});e.log("[AjaxUploader-Button] button change event was fired just now.");this._reset()}},{ATTRS:{target:{value:null},fileInput:{value:""},inputContainer:{value:""},tpl:{value:'<div class="file-input-wrapper"><input type="file" name="{name}" hidefoucs="true" class="file-input" /></div>'},name:{value:"fileInput",setter:function(c){this.get("fileInput")&&
g(this.get("fileInput")).attr("name",c);return c}},disabled:{value:false,setter:function(c){c?this.hide():this.show();return c}},multiple:{value:true,setter:function(c){var a=this.get("fileInput");if(a.length)c&&a.attr("multiple","multiple")||a.removeAttr("multiple");return c}},cls:{value:{disabled:"uploader-button-disabled"}}}});return i},{requires:["node","base"]});
KISSY.add("form/uploader/button/swfButton",function(e,m,k,i){function g(a,d){d=e.merge({target:c(a)},d);g.superclass.constructor.call(this,d)}var c=m.all;e.mix(g,{event:{RENDER:"render",CHANGE:"change",MOUSE_OVER:"mouseOver",MOUSE_DOWN:"mouseDown",MOUSE_UP:"mouseUp",MOUSE_OUT:"mouseOut",CLICK:"click"}});e.extend(g,k,{render:function(){var a=this,d=a.get("target"),b,f=a.get("multiple"),h=a.get("fileFilters");d.css("position","relative");a.set("swfWrapper",a._createSwfWrapper());a._setFlashSizeConfig();
b=a._initSwfUploader();b.on("contentReady",function(){b.browse(f,h);a._bindBtnEvent();b.on("fileSelect",a._changeHandler,a);a._setDisabled(a.get("disabled"));a.fire(g.event.RENDER)},a)},_createSwfWrapper:function(){var a=this.get("target"),d=this.get("tpl"),b=this.get("swfWrapperId")!=""&&this.get("swfWrapperId")||"swf-uploader-wrapper-"+e.guid();d=e.substitute(d,{id:b});this.set("swfWrapperId",b);return c(d).appendTo(a)},_initSwfUploader:function(){var a=this.get("flash"),d=this.get("swfWrapperId"),
b;try{b=new i(d,a);this.set("swfUploader",b)}catch(f){}return b},_bindBtnEvent:function(){var a=this,d=g.event,b=a.get("swfUploader");if(!b)return false;e.each(d,function(f){b.on(f,function(){a.fire(f)},a)});return a},_setFlashSizeConfig:function(){var a=this.get("flash"),d=this.get("target");e.mix(a.attrs,{width:d.width(),height:d.height()});this.set("flash",a)},_changeHandler:function(a){this.fire(g.event.CHANGE,{files:a.fileList})},_setDisabled:function(a){var d=this.get("swfUploader"),b=this.get("cls").disabled,
f=this.get("target"),h=this.get("swfWrapper");if(!d||!e.isBoolean(a))return false;if(a){f.addClass(b);h.hide()}else{f.removeClass(b);h.show()}return a}},{ATTRS:{target:{value:""},swfWrapper:{value:""},swfWrapperId:{value:""},tpl:{value:'<div id="{id}" class="uploader-button-swf" style="position: absolute;top:0;left:0;"></div>'},multiple:{value:true,setter:function(a){var d=this.get("swfUploader");d&&d.multifile(a);return a}},fileFilters:{value:[],setter:function(a){var d=this.get("swfUploader");d&&
e.isArray(a)&&d.filter(a);return a}},disabled:{value:false,setter:function(a){this.get("swfUploader")&&this._setDisabled(a);return a}},cls:{value:{disabled:"uploader-button-disabled"}},flash:{value:{src:"../plugins/ajbridge/uploader.swf",id:"swfUploader",params:{bgcolor:"#fff",wmode:"transparent"},attrs:{},hand:true,btn:true}},swfUploader:{value:""}}});return g},{requires:["node","base","form/uploader/plugins/ajbridge/uploader"]});
KISSY.add("form/uploader/plugins/ajbridge/ajbridge",function(e,m){function k(d,b,f){d=d.replace(i,"");b=m._normalize(b||{});var h=this;d=i+d;var j=function(l){if(l.status<1)h.fire("failed",{data:l});else{e.mix(h,l);if(!l.dynamic||!b.src)h.activate()}};b.id=b.id||e.guid(g);k.instances[b.id]=h;if(b.src){b.params.allowscriptaccess="always";b.params.flashvars=e.merge(b.params.flashvars,{jsEntry:a,swfID:b.id})}if(f)h.__args=[d,b,j];else e.later(m.add,c,false,m,[d,b,j])}var i="#",g="ks-ajb-",c=100,a="KISSY.AJBridge.eventHandler";
e.app(k,{version:"1.0.15",instances:{},eventHandler:function(d,b){var f=k.instances[d];f&&f.__eventHandler(d,b)},augment:function(d,b){if(e.isString(b))b=[b];e.isArray(b)&&e.each(b,function(f){d.prototype[f]=function(){try{return this.callSWF(f,e.makeArray(arguments))}catch(h){this.fire("error",{message:h})}}})}});e.augment(k,e.EventTarget,{init:function(){if(this.__args){m.add.apply(m,this.__args);this.__args=null;delete this.__args}},__eventHandler:function(d,b){var f=b.type;b.id=d;switch(f){case "log":e.log(b.message);
break;default:this.fire(f,b)}},callSWF:function(d,b){b=b||[];try{if(this.swf[d])return this.swf[d].apply(this.swf,b)}catch(f){var h="";if(b.length!==0)h="'"+b.join("','")+"'";return(new Function("self","return self.swf."+d+"("+h+");"))(this)}}});k.augment(k,["activate","getReady","getCoreVersion"]);return window.AJBridge=e.AJBridge=k},{requires:["flash"]});
KISSY.add("form/uploader/plugins/ajbridge/uploader",function(e,m,k){function i(g,c){c=c||{};var a={};e.each(["ds","dsp","btn","hand"],function(d){if(d in c)a[d]=c[d]});c.params=c.params||{};c.params.flashvars=e.merge(c.params.flashvars,a);i.superclass.constructor.call(this,g,c)}e.extend(i,k);k.augment(i,["setFileFilters","filter","setAllowMultipleFiles","multifile","browse","upload","uploadAll","cancel","getFile","removeFile","lock","unlock","setBtnMode","useHand","clear"]);i.version="1.0.1";k.Uploader=
i;return k.Uploader},{requires:["flash","form/uploader/plugins/ajbridge/ajbridge"]});
KISSY.add("form/uploader/plugins/progressBar/progressBar",function(e,m,k){function i(c,a){a=e.merge({wrapper:g(c)},a);i.superclass.constructor.call(this,a)}var g=m.all;e.mix(i,{tpl:{DEFAULT:'<div class="ks-progress-bar-value" data-value="{value}"></div>'},cls:{PROGRESS_BAR:"ks-progress-bar",VALUE:"ks-progress-bar-value"},event:{RENDER:"render",CHANGE:"change",SHOW:"show",HIDE:"hide"}});e.extend(i,k,{render:function(){var c=this.get("wrapper"),a=this.get("width");if(!c.length)return false;c.addClass(i.cls.PROGRESS_BAR).width(a);
this._addAttr();!this.get("visible")&&this.hide();this.set("bar",this._create());this.fire(i.event.RENDER)},show:function(){var c=this;c.get("wrapper").fadeIn(c.get("duration"),function(){c.set("visible",true);c.fire(i.event.SHOW,{visible:true})})},hide:function(){var c=this;c.get("wrapper").fadeOut(c.get("duration"),function(){c.set("visible",false);c.fire(i.event.HIDE,{visible:false})})},_create:function(){var c=this.get("wrapper"),a=this.get("value"),d=this.get("tpl");a=e.substitute(d,{value:a});
c.html("");return g(a).appendTo(c)},_addAttr:function(){var c=this.get("wrapper"),a=this.get("value");c.attr("role","progressbar");c.attr("aria-valuemin",0);c.attr("aria-valuemax",100);c.attr("aria-valuenow",a);return this}},{ATTRS:{wrapper:{value:""},bar:{value:""},width:{value:100},value:{value:0,setter:function(c){var a=this,d=a.get("wrapper"),b=a.get("bar"),f=a.get("speed"),h;if(c>100)c=100;if(c<0)c=0;h=d.width()*(c/100);b.animate({width:h+"px"},f,"none",function(){d.attr("aria-valuenow",c);b.attr("data-value",
c);a.fire(i.event.CHANGE,{value:c,width:h})});return c}},visible:{value:true},duration:{value:0.3},tpl:{value:i.tpl.DEFAULT},speed:{value:0.2}}});return i},{requires:["node","base"]});
KISSY.add("form/uploader/queue/base",function(e,m,k,i){function g(a,d){g.superclass.constructor.call(this,d);this.set("target",c(a))}var c=m.all;e.mix(g,{tpl:{DEFAULT:'<li id="queue-file-{id}" class="clearfix" data-name="{name}"><div class="f-l sprite file-icon"></div><div class="f-l">{name}</div><div class="f-l file-status J_FileStatus"></div></li>'},event:{ADD:"add",REMOVE:"remove",CLEAR:"clear"},status:i.type,cls:{QUEUE:"ks-uploader-queue"},hook:{STATUS:".J_FileStatus"},FILE_ID_PREFIX:"file-"});
e.extend(g,k,{render:function(){this.get("target").addClass(g.cls.QUEUE);return this},add:function(a,d){var b=this,f=g.event;if(a.length>0){b._addFiles(a,function(){d&&d.call(b);b.fire(f.ADD)});return false}else return b._addFile(a,function(h,j){d&&d.call(b,h,j);b.fire(f.ADD,{index:h,file:j,target:j.target})})},_addFile:function(a,d){if(!e.isObject(a)){e.log("[uploader-queue]:_addFile()参数file不合法！");return false}var b=this,f=b.get("duration"),h=b._setAddFileData(a),j=b.getFileIndex(h.id);b.fileStatus(j,
g.status.WAITING);h.target.fadeIn(f,function(){d&&d.call(b,j,h)});return h},_addFiles:function(a,d){function b(h){if(h===a.length){d&&d.call(this);return false}f._addFile(a[h],function(){h++;b(h)})}if(!a.length){e.log("[uploader-queue]:_addFiles()参数files不合法！");return false}var f=this;b(0)},remove:function(a,d){var b=this,f=b.get("files"),h,j,l=b.get("duration");if(e.isString(a))a=b.getFileIndex(a);h=f[a];if(!e.isObject(h)){e.log("[uploader-queue]:remove()不存在index为"+a+"的文件数据");return false}j=h.target;
j.fadeOut(l,function(){j.remove();d&&d.call(b,a,h);b.fire(g.event.REMOVE,{index:a,file:h})});f=e.filter(f,function(n,o){return o!==a});b.set("files",f);return h},clear:function(){function a(){b=d.get("files");if(!b.length){d.fire(g.event.CLEAR);return false}d.remove(0,function(){a()})}var d=this,b;a()},fileStatus:function(a,d,b){if(!e.isNumber(a))return false;a=this.getFile(a);if(!e.isPlainObject(a))return false;a=a.status;d&&a.change(d,b);return a},getFile:function(a){if(!e.isNumber(a))return false;
a=this.get("files")[a];e.isPlainObject(a)||(a=false);return a},getFileIndex:function(a){var d=this.get("files"),b=-1;e.each(d,function(f,h){if(f.id==a){b=h;return true}});return b},updateFile:function(a,d){if(!e.isNumber(a))return false;if(!e.isObject(d)){e.log("[uploader-queue]:updateFile()的data参数有误！");return false}var b=this.get("files"),f=this.getFile(a);if(!f)return false;e.mix(f,d);b[a]=f;this.set("files",b);return f},getIndexs:function(a){var d=this.get("files"),b,f=[];if(!d.length)return f;
e.each(d,function(h,j){if(e.isObject(h)){b=h.status;b.get("curType")==a&&f.push(j)}});return f},getFiles:function(a){var d=this.get("files"),b,f=[];if(!d.length)return false;e.each(d,function(h){if(h){b=h.status;b.get("curType")==a&&f.push(h)}});return f},_setAddFileData:function(a){var d=this.get("files"),b=this.get("uploader");if(!e.isObject(a)){e.log("[uploader-queue]:_updateFileData()参数file不合法！");return false}if(!a.id)a.id=e.guid(g.FILE_ID_PREFIX);if(a.size)a.textSize=i.convertByteSize(a.size);
a.target=this._appendFileHtml(a);a.status=this._renderStatus(a);e.isObject(b)&&a.status.set("uploader",b);d.push(a);return a},_appendFileHtml:function(a){var d=this.get("target"),b=this.get("tpl");b=e.substitute(b,a);return c(b).hide().appendTo(d).data("data-file",a)},_renderStatus:function(a){var d=a.target;if(!d.length)return false;d=d.children(g.hook.STATUS);return new i(d,{queue:this,file:a})}},{ATTRS:{tpl:{value:g.tpl.DEFAULT},duration:{value:0.3},target:{value:""},files:{value:[]},uploader:{value:""}}});
return g},{requires:["node","base","./status"]});
KISSY.add("form/uploader/queue/status",function(e,m,k,i){function g(a,d){d=e.merge({target:c(a)},d);g.superclass.constructor.call(this,d)}var c=m.all;e.mix(g,{type:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error"},convertByteSize:function(a){var d=-1;do{a/=1024;d++}while(a>99);return Math.max(a,0.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][d]}});e.extend(g,k,{change:function(a,d){if(!e.isString(a))return false;var b;if(!this.isSupport(a)){e.log("[queue-status]:status参数为"+
a+"，不支持的状态类型");return false}d||(d={});(b=this["_"+a])&&b.call(this,d);this.set("curType",a);return this},isSupport:function(a){if(!e.isString(a))return false;var d=false;e.each(g.type,function(b){if(a==b)return d=true});return d},_changeDom:function(a){var d=this.get("target");d.html("");return c(a).appendTo(d)},_waiting:function(){var a=this.get("tpl").waiting,d=this.get("uploader"),b=this.get("queue"),f=this.get("file").id,h=b.getFileIndex(f);this._changeDom(a).children(".J_Upload").on("click",
function(j){j.preventDefault();if(!e.isObject(d))return false;d.upload(h)})},_start:function(){var a=this.get("tpl").start,d=this.get("target"),b=this.get("uploader"),f=b.get("type");if(!e.isString(a))return false;a=this._changeDom(a);a.children(".J_UploadCancel").on("click",function(h){h.preventDefault();if(!e.isObject(b))return false;b.cancel()});if(f=="ajax"||f=="flash"){f=a.children(".J_ProgressBar");f=new i(f);f.render();this.set("progressBar",f)}d.parent().addClass("current-upload-file")},_progress:function(a){a=
Math.ceil(a.loaded/a.total)*100;var d=this.get("progressBar");if(!d)return false;d.set("value",a)},_success:function(){var a=this.get("tpl").success,d=this.get("target"),b=this.get("queue"),f=this.get("file").id,h=this.get("progressBar"),j=this.get("target"),l;if(!e.isString(a))return false;if(e.isObject(h))l=j.children().children(".J_ProgressBar").clone(true);a=this._changeDom(a);l&&a.prepend(l);a.children(".J_FileDel").on("click",function(n){n.preventDefault();b.remove(f)});d.parent().removeClass("current-upload-file")},
_cancel:function(){var a=this.get("tpl").cancel,d=this.get("uploader");a=this._changeDom(a).children(".J_ReUpload");var b=this.get("file").id;a.on("click",function(f){f.preventDefault();if(!e.isObject(d))return false;d.upload(b)})},_error:function(a){e.isObject(a)||(a={msg:"文件上传失败！"});var d=this.get("tpl").error;a=this._changeDom(e.substitute(d,a)).children(".J_FileDel");var b=this.get("queue"),f=this.get("file").id;a.on("click",function(h){h.preventDefault();b.remove(f)})}},{ATTRS:{target:{value:""},
tpl:{value:{waiting:'<div class="waiting-status">等待上传，<a href="#Upload" class="J_Upload">点此上传</a> </div>',start:'<div class="start-status clearfix"><div class="f-l  J_ProgressBar uploader-progress"><img class="loading" src="http://img01.taobaocdn.com/tps/i1/T1F5tVXjRfXXXXXXXX-16-16.gif" alt="loading" /></div> <a class="f-l J_UploadCancel upload-cancel" href="#uploadCancel">取消</a></div> ',success:' <div class="success-status"><a href="#fileDel" class="J_FileDel">删除</a></div>',cancel:'<div class="cancel-status">已经取消上传，<a href="#reUpload" class="J_ReUpload">点此重新上传</a> </div>',
error:'<div class="error-status upload-error">{msg}<a href="#fileDel" class="J_FileDel">点此删除</a></div>'}},queue:{value:""},uploader:{value:""},file:{value:{}},curType:{value:""},progressBar:{value:""}}});return g},{requires:["node","base","../plugins/progressBar/progressBar"]});
KISSY.add("form/uploader/render",function(e,m,k,i,g,c){function a(j,l){var n={},o,q=l||h.CONFIG;o=b(j).attr(q);if(!e.isString(o))return{};try{n=JSON.parse(o)}catch(p){e.log(f+"请检查"+j+"上"+q+"属性内的json格式是否符合规范！")}return n}function d(j,l,n){n=e.mix(a(j),n);d.superclass.constructor.call(this,n);this.set("buttonTarget",j);this.set("queueTarget",l);this.set("uploaderConfig",n);this._init()}var b=k.all,f="[uploaderRender]:",h={CONFIG:"data-config"};e.extend(d,m,{_init:function(){var j=this,l=j.get("uploaderConfig"),
n=j._initButton(),o;j.set("button",n);j._initThemes(function(q){o=q.get("queue");e.mix(l,{button:n,queue:o});var p=new i(l);p.render();j.set("uploader",p);q.afterUploaderRender&&q.afterUploaderRender(p);j.fire("init",{uploader:p})})},_initButton:function(){var j=this.get("buttonTarget"),l=this.get("name");return this.get("type")!="flash"&&new g(j,{name:l})||new c(j)},_initThemes:function(j){var l=this,n=l.get("theme");e.use(n+"/index",function(o,q){var p=l.get("queueTarget");p=new q({queueTarget:p});
j&&j.call(l,p)})},_initQueue:function(){var j=this.get("queueTarget");return new Queue(j)},_auth:function(){}},{ATTRS:{theme:{value:"form/uploader/themes/default"},buttonTarget:{value:""},queueTarget:{value:""},uploaderConfig:{},button:{value:""},queue:{value:""},uploader:{value:""}}});return d},{requires:["base","node","./base","./button/base","./button/swfButton"]});
KISSY.add("form/uploader/themes/default/index",function(e,m,k,i){function g(c){g.superclass.constructor.call(this,c);this._init()}e.extend(g,k,{_init:function(){var c=this.get("queueTarget");this.set("queue",new i(c))},afterUploaderRender:function(){}},{ATTRS:{queueTarget:{value:""},queue:{value:""}}});return g},{requires:["node","base","../../queue/base","./style.css"]});
KISSY.add("form/uploader/themes/grayQueue/index",function(e,m,k,i){function g(a){g.superclass.constructor.call(this,a)}var c=m.all;e.extend(g,k,{_init:function(){var a=this.get("queueTarget");this.set("queue",new i(a))},afterUploaderRender:function(a){var d=a.get("queue"),b=c(this.get("elStartUpload")),f=c(this.get("elTotalProgressNum")),h=this.get("startUploadDisabledCls");d.on("add",function(){b.removeClass(h)});a.on("uploadAll",function(){var j=a.get("progressBar");j.set("value",100);j.hide();
f.text("100%")});b.on("click",function(j){j.preventDefault();if(!b.hasClass(h)){(j=a.get("progressBar"))&&j.show();a.uploadAll()}})}},{ATTRS:{elStartUpload:{value:"#J_StartUpload"},startUploadDisabledCls:{value:"start-upload-disabled"},elTotalProgressNum:{value:"#J_TotalProgressNum"}}});return g},{requires:["node","../default/index","./queue","./style.css"]});
KISSY.add("form/uploader/themes/grayQueue/queue",function(e,m,k,i){function g(c){g.superclass.constructor.call(this,c)}g.event=k.event;g.status=k.status;e.extend(g,k,{_renderStatus:function(c){var a=c.target;if(!a.length)return false;a=a.children(".J_FileStatus");return new i(a,{queue:this,file:c})}},{ATTRS:{tpl:{value:'<li id="queue-file-{id}" class="clearfix queue-file" data-name="{name}"><div class="f-l file-name">{name}</div><div class="f-r file-status J_FileStatus">0%</div><div class="f-r file-size">{textSize}</div></li>'}}});
return g},{requires:["node","../../queue/base","./status"]});
KISSY.add("form/uploader/themes/grayQueue/status",function(e,m,k,i){function g(a,d){g.superclass.constructor.call(this,a,d);this.set("target",c(a))}var c=m.all;g.type=i.type;e.extend(g,i,{_waiting:function(){var a=this.get("tpl").waiting,d=this.get("uploader"),b=this.get("queue"),f=this.get("file"),h=f.id,j=d.get("total"),l=f.size;a=this._changeDom(a).children(".J_DelFile");a.length&&a.on("click",function(){b.remove(h);j-=l;c("#J_TotalSize").text(i.convertByteSize(j));d.set("total",j)});if(!l)return false;
if(j)j+=l;else{j=l;d.set("loaded",0)}c("#J_TotalSize").text(i.convertByteSize(j));d.set("total",j)},_start:function(){var a=this.get("tpl").start,d=this.get("target"),b=this.get("uploader"),f=b.get("type");if(!e.isString(a))return false;a=this._changeDom(a);if(f=="ajax"){if(!b.get("progressBar")){f=new k(c("#J_ProgressBar"));f.render();b.set("progressBar",f)}b.get("progressBar").set("value",0);b=a.children(".J_ProgressNum");b.html("0%");this.set("elProgressNum",b)}d.parent().addClass("current-upload-file")},
_progress:function(a){var d=a.loaded;a=Math.ceil(d/a.total*100);var b=this.get("uploader"),f=b.get("progressBar"),h=b.get("total");b=b.get("loaded");var j=this.get("elProgressNum");if(!j.length||f=="")return false;j.html(a+"%");d+=b;a=Math.ceil(d/h*100);f.set("value",a);c("#J_TotalProgressNum").text(a+"%")},_success:function(){var a=this.get("tpl").success,d=this.get("target");this.get("queue");var b=this.get("file").size,f=this.get("uploader"),h=f.get("loaded");if(!e.isString(a))return false;this._changeDom(a);
d.parent().removeClass("current-upload-file");if(!b)return false;h+=b;f.set("loaded",h)}},{ATTRS:{tpl:{value:{waiting:'<div class="clearfix"><div class="f-l">0%</div><div class="f-l uploader-icon del-icon J_DelFile"></div></div>',start:'<div class="clearfix"><div class="J_ProgressNum"><img class="loading" src="http://img01.taobaocdn.com/tps/i1/T1F5tVXjRfXXXXXXXX-16-16.gif" alt="loading" /></div></div> ',success:'<div class="uploader-icon success-icon">100%</div>',cancel:'<div>已经取消上传，<a href="#reUpload" class="J_ReUpload">点此重新上传</a> </div>',
error:'<div class="upload-error">{msg}<a href="#fileDel" class="J_FileDel">点此删除</a></div>'}}}});return g},{requires:["node","../../queue/progressBar","../../queue/status"]});
KISSY.add("form/uploader/type/ajax",function(e,m,k){function i(c){i.superclass.constructor.call(this,c);this._processData()}var g=m.all;e.mix(i,{event:e.merge(k.event,{PROGRESS:"progress"})});e.extend(i,k,{upload:function(c){if(!c){e.log("[uploader-AjaxType]:upload()，fileInput参数有误！");return false}var a=c.files;if(!a.length){e.log("[uploader-AjaxType]:upload()，不存在要上传的文件！");return false}this._addFileData(c,a[0]);this.send();return this},stop:function(){var c=this.get("xhr");if(!e.isObject(c)){e.log("[uploader-AjaxType]:stop()，io值错误！");
return false}c.abort();this.fire(i.event.STOP);return this},send:function(){var c=this,a=c.get("action"),d=c.get("formData"),b=new XMLHttpRequest;b.upload.addEventListener("progress",function(f){c.fire(i.event.PROGRESS,{loaded:f.loaded,total:f.total})});b.onload=function(){var f={};try{f=e.JSON.parse(b.responseText)}catch(h){e.log("[uploader-AjaxType]:ajax返回结果集responseText格式不合法！")}c.fire(i.event.SUCCESS,{result:f})};b.open("POST",a,true);b.send(d);c.set("xhr",b);return c},_processData:function(){var c=
this.get("data"),a=this.get("formData");e.each(c,function(d,b){a.append(b,d)});this.set("formData",a)},_addFileData:function(c,a){if(!e.isObject(a)){e.log("[uploader-AjaxType]:_addFileData()，file参数有误！");return false}var d=this.get("formData"),b=this.get("fileDataName");if(b==""){b=g(c).attr("name");this.set("fileDataName",b)}d.append(b,a);this.set("formData",d)}},{ATTRS:{formData:{value:new FormData},ajaxConfig:{value:{type:"post",processData:false,cache:false,dataType:"json",contentType:false}},
xhr:{value:""},fileDataName:{value:""},form:{value:{}},fileInput:{value:""}}});return i},{requires:["node","./base"]});KISSY.add("form/uploader/type/base",function(e,m,k){function i(g){i.superclass.constructor.call(this,g)}e.mix(i,{event:{START:"start",STOP:"stop",SUCCESS:"success",ERROR:"error"}});e.extend(i,k,{upload:function(){},stop:function(){}},{ATTRS:{action:{value:""},data:{value:{}}}});return i},{requires:["node","base"]});
KISSY.add("form/uploader/type/flash",function(e,m,k){function i(g){i.superclass.constructor.call(this,g);this._init()}e.mix(i,{event:e.merge(k.event,{SWF_READY:"swfReady",PROGRESS:"progress"})});e.extend(i,k,{_init:function(){var g=this,c=g.get("swfUploader");if(!c){e.log("[uploader-FlashType]:swfUploader对象为空！");return false}c.on("contentReady",function(){g.fire(i.event.SWF_READY)},g);c.on("uploadStart",g._uploadStartHandler,g);c.on("uploadProgress",g._uploadProgressHandler,g);c.on("uploadCompleteData",
g._uploadCompleteDataHandler,g);c.on("uploadError",g._uploadErrorHandler,g)},upload:function(g){var c=this.get("swfUploader"),a=this.get("action"),d=this.get("data");this.set("uploadingId",g);c.upload(g,a,"POST",d);return this},stop:function(){var g=this.get("swfUploader"),c=this.get("uploadingId");if(c!=""){g.cancel(c);this.fire(i.event.STOP,{id:c})}return this},_uploadStartHandler:function(g){this.fire(i.event.START,{file:g.file})},_uploadProgressHandler:function(g){e.mix(g,{loaded:g.bytesLoaded,
total:g.bytesTotal});this.fire(i.event.PROGRESS,{loaded:g.loaded,total:g.total})},_uploadCompleteDataHandler:function(g){var c;try{c=JSON.parse(g.data)}catch(a){e.log("[uploader-FlashType]:json数据格式不合法！");this.fire(i.event.ERROR,{msg:"不是合法的json数据"})}this.set("uploadingId","");this.fire(i.event.SUCCESS,{result:c})},_uploadErrorHandler:function(g){this.set("uploadingId","");this.fire(i.event.ERROR,{msg:g.msg})}},{ATTRS:{swfUploader:{value:""},uploadingId:{value:""}}});return i},{requires:["node","./base"]});
KISSY.add("form/uploader/type/iframe",function(e,m,k){function i(c){i.superclass.constructor.call(this,c)}var g=m.all;e.mix(i,{tpl:{IFRAME:'<iframe src="javascript:false;" name="{id}" id="{id}" border="no" width="1" height="1" style="display: none;" />',FORM:'<form method="post" enctype="multipart/form-data" action="{action}" target="{target}">{hiddenInputs}</form>',HIDDEN_INPUT:'<input type="hidden" name="{name}" value="{value}" />'},event:e.mix(k.event,{CREATE:"create",REMOVE:"remove"})});e.extend(i,
k,{upload:function(c){c=g(c);if(!c.length)return false;this.fire(i.event.START,{input:c});this.set("fileInput",c);this._create();this.get("form").getDOMNode().submit()},stop:function(){this.get("iframe").attr("src",'javascript:"<html></html>";');this.fire(i.event.STOP);this.fire(i.event.ERROR,{status:"abort",msg:"上传失败，原因：abort"});return this},dataToHidden:function(c){if(!e.isObject(c)||e.isEmptyObject(c)){e.log("[uploader-iframeType]:data参数不是对象或者为空！");return false}var a="",d=this.get("tpl").HIDDEN_INPUT;
if(!e.isString(d))return false;for(var b in c)a+=e.substitute(d,{name:b,value:c[b]});return a},_createIframe:function(){var c=this.get("id"),a=this.get("tpl"),d=a.IFRAME,b=this.get("iframe");if(!e.isEmptyObject(b))return b;if(!e.isString(d)){e.log("[uploader-iframeType]:iframe的模板不合法！");return false}if(!e.isString(c)){e.log("[uploader-iframeType]:id必须存在且为字符串类型！");return false}c=e.substitute(a.IFRAME,{id:c});c=g(c);c.on("load",this._iframeLoadHandler,this);g("body").append(c);this.set("iframe",c);return c},
_iframeLoadHandler:function(c){var a=c.target;c=i.event.ERROR;a=a.contentDocument||window.frames[a.id].document;if(!a||!a.body){this.fire(c,{msg:"服务器端返回数据有问题！"});return false}a=a.body.innerHTML;if(a=="")return false;try{a=JSON.parse(a)}catch(d){e.log("[uploader-iframeType]:json数据格式不合法！");this.fire(c,{msg:"数据："+a+"不是合法的json数据"})}this.fire(i.event.SUCCESS,{result:a});this._remove()},_createForm:function(){var c=this.get("id"),a=this.get("tpl").FORM,d=this.get("data"),b=this.get("action"),f=this.get("fileInput"),
h="";if(!e.isString(a)){e.log("[uploader-iframeType]:form模板不合法！");return false}if(!e.isObject(d)){e.log("[uploader-iframeType]:data参数不合法！");return false}if(!e.isString(b)){e.log("[uploader-iframeType]:action参数不合法！");return false}d=this.dataToHidden(d);if(d=="")return false;h=e.substitute(a,{action:b,target:c,hiddenInputs:d});c=g(h).append(f.clone());g("body").append(c);this.set("form",c);return c},_create:function(){var c=this._createIframe(),a=this._createForm();this.fire(i.event.CREATE,{iframe:c,
form:a})},_remove:function(){var c=this.get("form");this.get("iframe");c.remove();this.reset("form");this.fire(i.event.REMOVE,{form:c})}},{ATTRS:{tpl:{value:i.tpl},id:{value:"ks-uploader-iframe-"+e.guid()},iframe:{value:{}},form:{value:{}},fileInput:{value:""}}});return i},{requires:["node","./base"]});
KISSY.add("form/uploader/urlsInput",function(e,m,k){function i(c,a){i.superclass.constructor.call(this,a);this.set("wrapper",g(c))}var g=m.all;e.mix(i,{TPL:'<input type="hidden" id="{name}" name="{name}" value="{value}" />'});e.extend(i,k,{render:function(){var c=this.get("wrapper"),a=this.get("name");a=document.getElementsByName(a)[0];if(!e.isObject(c)){e.log("[uploader-urlsInput]:container参数不合法！");return false}a?this.set("input",g(a)):this._create()},add:function(c){if(!e.isString(c)){e.log("[uploader-urlsInput]:add()的url参数不合法！");
return false}var a=this.get("urls");if(this.isExist(c)){e.log("[uploader-urlsInput]:add()，文件路径已经存在！");return this}a.push(c);this.set("urls",a);this._val();return this},remove:function(c){var a=this.get("urls");if(!this.isExist(c)){e.log("[uploader-urlsInput]:remove()，不存在该文件路径！");return false}a=e.filter(a,function(d){return d!=c});this.set("urls",a);this._val();return a},_val:function(){var c=this.get("urls"),a=this.get("input"),d=this.get("split");c=c.join(d);a.val(c);return c},isExist:function(c){var a=
false,d=this.get("urls");if(!d.length)return false;e.each(d,function(b){if(b==c)return a=true});return a},_create:function(){var c=this.get("wrapper"),a=this.get("tpl"),d=this.get("name"),b=this.get("urls");if(!e.isString(a)||!e.isString("name")){e.log("[uploader-urlsInput]:_create()，tpl和name属性不合法！");return false}a=g(e.substitute(a,{name:d,value:b}));c.append(a);this.set("input",a);return a}},{ATTRS:{name:{value:""},urls:{value:[]},tpl:{value:i.TPL},split:{value:",",setter:function(c){this._val();
return c}},input:{value:""},wrapper:{value:""}}});return i},{requires:["node","base"]});
