KISSY.add("form/uploader/base",function(d,m,k,h,i,c){function a(b){a.superclass.constructor.call(this,b)}d.mix(a,{type:{AUTO:"auto",IFRAME:"iframe",AJAX:"ajax"},event:{RENDER:"render",SELECT:"select",START:"start",COMPLETE:"complete",SUCCESS:"success",UPLOAD_ALL:"uploadAll",ERROR:"error"}});d.extend(a,m,{render:function(){var b=this.get("serverConfig"),e=this.getUploadType(),f=e.event;if(!e)return false;this.set("urlsInput",this._renderUrlsInput());this._renderQueue();this._renderButton();b=new e(b);
b.on(f.SUCCESS,this._uploadCompleteHanlder,this);f.PROGRESS&&b.on(f.PROGRESS,this._uploadProgressHandler,this);b.on(f.STOP,this._uploadStopHanlder,this);this.set("uploadType",b);this.fire(a.event.RENDER);return this},upload:function(b){if(!d.isNumber(b))return false;var e=this.get("uploadType"),f=this.get("queue"),g=f.get("files")[b],j;if(!d.isPlainObject(g)){d.log("[uploader]:队列中不存在id为"+b+"的文件");return false}if(this.get("curUploadId")!=""){alert("有文件正在上传，请上传完后再操作！");return false}j=g.input;this.fire(a.event.START,
{id:b,file:g});if(!this.get("isAllowUpload"))return false;this.set("curUploadId",b);f.fileStatus(b,f.constructor.status.START);e.upload(j)},cancel:function(){this.get("uploadType").stop();return this},uploadAll:function(){this.set("isUploadWaitFiles",true);this.uploadWaitFile()},uploadWaitFile:function(){if(!this.get("queue").getIndexs("waiting").length){this.set("isUploadWaitFiles",false);this.fire(a.event.UPLOAD_ALL);return false}this.upload(0)},isSupportAjax:function(){return d.isObject(FormData)},
getUploadType:function(){var b=this.get("type"),e=a.type,f=this.isSupportAjax();switch(b){case e.AUTO:if(f){b=c;this.set("type",a.type.AJAX)}else{b=i;this.set("type",a.type.IFRAME)}break;case e.IFRAME:b=i;break;case e.AJAX:b=c;if(!f){b=i;this.set("type",a.type.IFRAME);d.log("[uploader]:由于你的浏览器不支持ajax上传，强制降级为iframe！")}break;default:d.log("[uploader]:type参数不合法，只允许配置值为"+e.AUTO+","+e.IFRAME+","+e.AJAX);return false}return b},_renderButton:function(){var b=this.get("button");if(!d.isObject(b)){d.log("[uploader]:button参数不合法！");
return false}b.on("change",this._select,this);b.render();return b},_renderQueue:function(){var b=this.get("queue"),e=this.get("urlsInput");if(!d.isObject(b)){d.log("[uploader]:queue参数不合法");return false}b.set("uploader",this);b.on(b.constructor.event.REMOVE,function(f){e.remove(f.file.sUrl)});b.render();return b},_select:function(b){var e=this.get("autoUpload"),f=this.get("queue"),g=this.get("curUploadId"),j=b.files[0];b={name:j.fileName||j.name,input:b.input,file:j,size:j.size||0};this.set("curFileData",
b);this.fire(a.event.SELECT,b);if(!this.get("isAllowUpload"))return false;f=f.add(b);g===""&&e&&this.upload(f)},_renderUrlsInput:function(){var b=this.get("button").target,e=this.get("urlsInputName");b=new h(b,{name:e});b.render();return b},_uploadCompleteHanlder:function(b){b=b.result;var e,f=a.event,g=this.get("queue"),j=this.get("curUploadId");if(!d.isObject(b))return false;if(e=b.status){g.fileStatus(j,g.constructor.status.SUCCESS);this._success(b.data);this.fire(f.SUCCESS)}else{g.fileStatus(j,
g.constructor.status.ERROR);this.fire(f.ERROR,{status:e})}this.set("curUploadId","");this.fire(f.COMPLETE);this.get("isUploadWaitFiles")&&this.uploadWaitFile()},_uploadStopHanlder:function(){var b=this.get("queue"),e=this.get("curUploadId");b.fileStatus(e,b.constructor.status.CANCEL);this.set("curUploadId","")},_uploadProgressHandler:function(b){var e=this.get("queue"),f=this.get("curUploadId");e.fileStatus(f,e.constructor.status.PROGRESS,b)},_success:function(b){if(!d.isObject(b))return false;b=
b.url;var e=this.get("urlsInput"),f=this.get("curUploadId"),g=this.get("queue");if(!d.isString(b)||!d.isObject(e))return false;g.updateFile(f,{sUrl:b});e.add(b)},_error:function(){},_addFileServerUrl:function(b,e){if(!d.isNumber(b)||!d.isString(e))return false;this.get("queue").getFile(b)}},{ATTRS:{button:{value:{}},queue:{value:{}},type:{value:a.type.AUTO},serverConfig:{value:{action:"",data:{},dataType:"json"}},isAllowUpload:{value:true},autoUpload:{value:true},urlsInputName:{value:""},curUploadId:{value:""},
curFileData:{value:{}},uploadType:{value:{}},urlsInput:{value:""},isUploadWaitFiles:{value:false}}});return a},{requires:["base","node","./urlsInput","./type/iframe","./type/ajax"]});
KISSY.add("form/uploader/button/base",function(d,m,k){function h(c,a){h.superclass.constructor.call(this,a);this.set("target",i(c))}var i=m.all;d.mix(h,{event:{beforeShow:"beforeShow",afterShow:"afterShow",beforeHide:"beforeHide",afterHide:"afterHide",beforeRender:"beforeRender",afterRender:"afterRender",CHANGE:"change"}});d.extend(h,k,{render:function(){var c=this.get("target");if(this.fire(h.event.beforeRender)===false){d.log("[AjaxUploader-Button] button render was prevented.");return false}else{if(c==
null){d.log("[AjaxUploader-Button] Cannot find target!");return false}this._createInput();this.fire(h.event.afterRender);d.log("[AjaxUploader-Button] button was rendered just now.");return this}},show:function(){var c=this.get("target"),a=this.get("cls").disabled,b=this.get("fileInput");if(this.fire(h.event.beforeShow)===false)d.log("[AjaxUploader-Button] show button event was prevented.");else{i(c).removeClass(a);i(b).show();this.fire(h.event.afterShow);d.log("[AjaxUploader-Button] button showed.")}},
hide:function(){var c=this.get("target"),a=this.get("cls").disabled,b=this.get("fileInput");if(this.fire(h.event.beforeHide)===false)d.log("[AjaxUploader-Button] hide button event was prevented.");else{i(c).addClass(a);i(b).hide();this.fire(h.event.afterHide);d.log("[AjaxUploader-Button] button showed.")}},_reset:function(){var c=this.get("inputContainer");i(c).remove();this.set("inputContainer","");this.set("fileInput","");this._createInput();return this},_createInput:function(){var c=this.get("target"),
a=this.get("name"),b=this.get("tpl");this.get("multiple");if(!d.isString(a)||!d.isString(b)){d.log("[AjaxUploader-Button] No name or tpl specified.");return false}a=d.substitute(b,{name:a});a=i(a);i(a).appendTo(c);c=i(a).children("input");i(c).on("change",this._changeHandler,this);this.set("fileInput",c);this.set("inputContainer",a);return a},_changeHandler:function(c){var a=this.get("fileInput");if(i(a).val()==""){d.log("[AjaxUploader-Button] No file selected.");return false}this.fire(h.event.CHANGE,
{files:c.target.files,input:i(a).clone().getDOMNode()});d.log("[AjaxUploader-Button] button change event was fired just now.");this._reset()}},{ATTRS:{target:{value:null},fileInput:{value:""},inputContainer:{value:""},tpl:{value:'<div class="ks-ajax-uploader-input-container"><input type="file" name="{name}" hidefoucs="true" class="ks-ajax-uploader-input" /></div>'},name:{value:"fileInput",setter:function(c){this.get("fileInput")&&i(this.get("fileInput")).attr("name",c);return c}},disabled:{value:false,
setter:function(c){c?this.hide():this.show();return c}},cls:{value:{disabled:"uploader-button-disabled"}}}});return h},{requires:["node","base"]});
KISSY.add("form/uploader/queue/base",function(d,m,k,h){function i(a,b){i.superclass.constructor.call(this,b);this.set("target",c(a))}var c=m.all;d.mix(i,{tpl:{DEFAULT:'<li id="queue-file-{id}" class="clearfix" data-name="{name}"><div class="f-l sprite file-icon"></div><div class="f-l">{name}</div><div class="f-l file-status J_FileStatus"></div></li>'},event:{ADD:"add",REMOVE:"remove",CLEAR:"clear"},status:h.type,cls:{QUEUE:"ks-uploader-queue"},hook:{STATUS:".J_FileStatus"},FILE_ID_PREFIX:"file-"});
d.extend(i,k,{render:function(){this.get("target").addClass(i.cls.QUEUE);return this},add:function(a,b){var e=this,f=i.event,g=e.get("duration"),j,l={};if(!d.isObject(a)){d.log("[uploader-queue]:add()参数file不合法！");return false}l=e._setAddFileData(a);j=e.getFileIndex(l.id);e.fileStatus(j,i.status.WAITING);l.target.fadeIn(g,function(){b&&b.call(e,j,l);e.fire(f.ADD,{index:j,file:l,target:l.target})});return a},remove:function(a,b){var e=this,f=e.get("files"),g,j,l=e.get("duration");if(d.isString(a))a=
e.getFileIndex(a);g=f[a];if(!d.isObject(g)){d.log("[uploader-queue]:remove()不存在index为"+a+"的文件数据");return false}j=g.target;j.fadeOut(l,function(){j.remove();b&&b.call(e,g);e.fire(i.event.REMOVE,{id:a,file:g})});f=d.filter(f,function(p,n){return n!==a});e.set("files",f);return g},clear:function(){function a(){e=b.get("files");if(!e.length){b.fire(i.event.CLEAR);return false}b.remove(0,function(){a()})}var b=this,e;a()},fileStatus:function(a,b,e){if(!d.isNumber(a))return false;a=this.getFile(a);if(!d.isPlainObject(a))return false;
a=a.status;b&&a.change(b,e);return a},getFile:function(a){if(!d.isNumber(a))return false;a=this.get("files")[a];d.isPlainObject(a)||(a=false);return a},getFileIndex:function(a){var b=this.get("files"),e=-1;d.each(b,function(f,g){if(f.id==a){e=g;return true}});return e},updateFile:function(a,b){if(!d.isNumber(a))return false;if(!d.isObject(b)){d.log("[uploader-queue]:updateFile()的data参数有误！");return false}var e=this.get("files"),f=this.getFile(a);if(!f)return false;d.mix(f,b);e[a]=f;this.set("files",
e);return f},getIndexs:function(a){var b=this.get("files"),e,f=[];if(!b.length)return f;d.each(b,function(g,j){if(d.isObject(g)){e=g.status;e.get("curType")==a&&f.push(j)}});return f},getFiles:function(a){var b=this.get("files"),e,f=[];if(!b.length)return false;d.each(b,function(g){if(g){e=g.status;e.get("curType")==a&&f.push(g)}});return f},_setAddFileData:function(a){var b=this.get("files"),e=this.get("uploader");if(!d.isObject(a)){d.log("[uploader-queue]:_updateFileData()参数file不合法！");return false}a.id=
d.guid(i.FILE_ID_PREFIX);if(a.size)a.textSize=h.convertByteSize(a.size);a.target=this._appendFileHtml(a);a.status=this._renderStatus(a);d.isObject(e)&&a.status.set("uploader",e);b.push(a);return a},_appendFileHtml:function(a){var b=this.get("target"),e=this.get("tpl");e=d.substitute(e,a);return c(e).hide().appendTo(b).data("data-file",a)},_renderStatus:function(a){var b=a.target;if(!b.length)return false;b=b.children(i.hook.STATUS);return new h(b,{queue:this,file:a})}},{ATTRS:{tpl:{value:i.tpl.DEFAULT},
duration:{value:0.3},target:{value:""},files:{value:[]},uploader:{value:""}}});return i},{requires:["node","base","./status"]});
KISSY.add("form/uploader/queue/progressBar",function(d,m,k){function h(c,a){h.superclass.constructor.call(this,a);this.set("wrapper",i(c))}var i=m.all;d.mix(h,{tpl:{DEFAULT:'<div class="ks-progress-bar-value" data-value="{value}"></div>'},cls:{PROGRESS_BAR:"ks-progress-bar",VALUE:"ks-progress-bar-value"},event:{RENDER:"render",CHANGE:"change",SHOW:"show",HIDE:"hide"}});d.extend(h,k,{render:function(){var c=this.get("wrapper"),a=this.get("width");if(!c.length)return false;c.addClass(h.cls.PROGRESS_BAR).width(a);
this._addAttr();!this.get("visible")&&this.hide();this.set("bar",this._create());this.fire(h.event.RENDER)},show:function(){var c=this;c.get("wrapper").fadeIn(c.get("duration"),function(){c.set("visible",true);c.fire(h.event.SHOW,{visible:true})})},hide:function(){var c=this;c.get("wrapper").fadeOut(c.get("duration"),function(){c.set("visible",false);c.fire(h.event.HIDE,{visible:false})})},_create:function(){var c=this.get("wrapper"),a=this.get("value"),b=this.get("tpl");a=d.substitute(b,{value:a});
c.html("");return i(a).appendTo(c)},_addAttr:function(){var c=this.get("wrapper"),a=this.get("value");c.attr("role","progressbar");c.attr("aria-valuemin",0);c.attr("aria-valuemax",100);c.attr("aria-valuenow",a);return this}},{ATTRS:{wrapper:{value:""},bar:{value:""},width:{value:100},value:{value:0,setter:function(c){var a=this,b=a.get("wrapper"),e=a.get("bar"),f=a.get("speed"),g;if(c>100)c=100;if(c<0)c=0;g=b.width()*(c/100);e.animate({width:g+"px"},f,"none",function(){b.attr("aria-valuenow",c);e.attr("data-value",
c);a.fire(h.event.CHANGE,{value:c,width:g})});return c}},visible:{value:true},duration:{value:0.3},tpl:{value:h.tpl.DEFAULT},speed:{value:0.2}}});return h},{requires:["node","base"]});
KISSY.add("form/uploader/queue/status",function(d,m,k,h){function i(a,b){i.superclass.constructor.call(this,b);this.set("target",c(a))}var c=m.all;d.mix(i,{type:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error"},tpl:{LOADING:'<img src="http://img01.taobaocdn.com/tps/i1/T1F5tVXjRfXXXXXXXX-16-16.gif" alt="loading" />'},convertByteSize:function(a){var b=-1;do{a/=1024;b++}while(a>99);return Math.max(a,0.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][b]}});
d.extend(i,k,{change:function(a,b){if(!d.isString(a))return false;var e;if(!this.isSupport(a)){d.log("[queue-status]:status参数为"+a+"，不支持的状态类型");return false}b||(b={});(e=this["_"+a])&&e.call(this,b);this.set("curType",a);return this},isSupport:function(a){if(!d.isString(a))return false;var b=false;d.each(i.type,function(e){if(a==e)return b=true});return b},_changeDom:function(a){var b=this.get("target");b.html("");return c(a).appendTo(b)},_waiting:function(){var a=this.get("tpl").waiting,b=this.get("uploader"),
e=this.get("file").id;this._changeDom(a).children(".J_Upload").on("click",function(f){f.preventDefault();if(!d.isObject(b))return false;b.upload(e)})},_start:function(){var a=this.get("tpl").start,b=this.get("target"),e=this.get("uploader"),f=e.get("type");if(!d.isString(a))return false;a=this._changeDom(a);a.children(".J_UploadCancel").on("click",function(g){g.preventDefault();if(!d.isObject(e))return false;e.cancel()});if(f=="ajax"){f=a.children(".J_ProgressBar");f=new h(f);f.render();this.set("progressBar",
f)}b.parent().addClass("current-upload-file")},_progress:function(a){a=Math.ceil(a.loaded/a.total)*100;var b=this.get("progressBar");if(!b)return false;b.set("value",a)},_success:function(){var a=this.get("tpl").success,b=this.get("target"),e=this.get("queue"),f=this.get("file").id,g=this.get("progressBar"),j=this.get("target");if(!d.isString(a))return false;if(d.isObject(g)){g=j.children();g.children(".J_UploadCancel").remove();a=c(a).appendTo(g)}else a=this._changeDom(a);a.on("click",function(l){l.preventDefault();
e.remove(f)});b.parent().removeClass("current-upload-file")},_cancel:function(){var a=this.get("tpl").cancel,b=this.get("uploader");a=this._changeDom(a).children(".J_ReUpload");var e=this.get("file").id;a.on("click",function(f){f.preventDefault();if(!d.isObject(b))return false;b.upload(e)})},_error:function(a){d.isObject(a)||(a={msg:"文件上传失败！"});var b=this.get("tpl").error;a=this._changeDom(d.substitute(b,a)).children(".J_FileDel");var e=this.get("queue"),f=this.get("file").id;a.on("click",function(g){g.preventDefault();
e.remove(f)})}},{ATTRS:{target:{value:""},tpl:{value:{waiting:'<div class="waiting-status">等待上传，<a href="#Upload" class="J_Upload">点此上传</a> </div>',start:'<div class="start-status clearfix"><div class="f-l  J_ProgressBar uploader-progress"><img class="loading" src="http://img01.taobaocdn.com/tps/i1/T1F5tVXjRfXXXXXXXX-16-16.gif" alt="loading" /></div> <a class="f-l J_UploadCancel upload-cancel" href="#uploadCancel">取消</a></div> ',success:' <a href="#fileDel" class="J_FileDel">删除</a>  ',cancel:'<div class="cancel-status">已经取消上传，<a href="#reUpload" class="J_ReUpload">点此重新上传</a> </div>',
error:'<div class="error-status upload-error">{msg}<a href="#fileDel" class="J_FileDel">点此删除</a></div>'}},queue:{value:""},uploader:{value:""},file:{value:{}},curType:{value:""},progressBar:{value:""}}});return i},{requires:["node","base","./progressBar"]});
KISSY.add("form/uploader/render",function(d,m,k,h,i){function c(g,j){var l={},p,n=j||f.CONFIG;p=b(g).attr(n);if(!d.isString(p))return{};try{l=JSON.parse(p)}catch(o){d.log(e+"请检查"+g+"上"+n+"属性内的json格式是否符合规范！")}return l}function a(g,j,l){l=d.mix(c(g),l);a.superclass.constructor.call(this,l);this.set("buttonTarget",g);this.set("queueTarget",j);this.set("uploaderConfig",l);this._init()}var b=k.all,e="[uploaderRender]:",f={CONFIG:"data-config"};d.extend(a,m,{_init:function(){var g=this,j=g.get("uploaderConfig"),
l=g._initButton(),p;g.set("button",l);g._initThemes(function(n){p=n.get("queue");d.mix(j,{button:l,queue:p});var o=new h(j);o.render();g.set("uploader",o);n.afterUploaderRender&&n.afterUploaderRender(o);g.fire("init",{uploader:o})})},_initButton:function(){var g=this.get("buttonTarget"),j=this.get("name");return new i(g,{name:j})},_initThemes:function(g){var j=this,l=j.get("theme");d.use(l+"/index",function(p,n){var o=j.get("queueTarget");o=new n({queueTarget:o});g&&g.call(j,o)})},_initQueue:function(){var g=
this.get("queueTarget");return new Queue(g)},_auth:function(){}},{ATTRS:{theme:{value:"form/uploader/themes/default"},buttonTarget:{value:""},queueTarget:{value:""},uploaderConfig:{},button:{value:""},queue:{value:""},uploader:{value:""}}});return a},{requires:["base","node","./base","./button/base"]});
KISSY.add("form/uploader/themes/default/index",function(d,m,k,h){function i(c){i.superclass.constructor.call(this,c);this._init()}d.extend(i,k,{_init:function(){var c=this.get("queueTarget");this.set("queue",new h(c))},afterUploaderRender:function(){}},{ATTRS:{queueTarget:{value:""},queue:{value:""}}});return i},{requires:["node","base","../../queue/base","./style.css"]});
KISSY.add("form/uploader/themes/grayQueue/index",function(d,m,k,h){function i(a){i.superclass.constructor.call(this,a)}var c=m.all;d.extend(i,k,{_init:function(){var a=this.get("queueTarget");this.set("queue",new h(a))},afterUploaderRender:function(a){var b=a.get("queue"),e=c(this.get("elStartUpload")),f=c(this.get("elTotalProgressNum")),g=this.get("startUploadDisabledCls");b.on("add",function(){e.removeClass(g)});a.on("uploadAll",function(){var j=a.get("progressBar");j.set("value",100);j.hide();
f.text("100%")});e.on("click",function(j){j.preventDefault();if(!e.hasClass(g)){(j=a.get("progressBar"))&&j.show();a.uploadAll()}})}},{ATTRS:{elStartUpload:{value:"#J_StartUpload"},startUploadDisabledCls:{value:"start-upload-disabled"},elTotalProgressNum:{value:"#J_TotalProgressNum"}}});return i},{requires:["node","../default/index","./queue","./style.css"]});
KISSY.add("form/uploader/themes/grayQueue/queue",function(d,m,k,h){function i(c){i.superclass.constructor.call(this,c)}i.event=k.event;i.status=k.status;d.extend(i,k,{_renderStatus:function(c){var a=c.target;if(!a.length)return false;a=a.children(".J_FileStatus");return new h(a,{queue:this,file:c})}},{ATTRS:{tpl:{value:'<li id="queue-file-{id}" class="clearfix queue-file" data-name="{name}"><div class="f-l file-name">{name}</div><div class="f-r file-status J_FileStatus">0%</div><div class="f-r file-size">{textSize}</div></li>'}}});
return i},{requires:["node","../../queue/base","./status"]});
KISSY.add("form/uploader/themes/grayQueue/status",function(d,m,k,h){function i(a,b){i.superclass.constructor.call(this,a,b);this.set("target",c(a))}var c=m.all;i.type=h.type;d.extend(i,h,{_waiting:function(){var a=this.get("tpl").waiting,b=this.get("uploader"),e=this.get("queue"),f=this.get("file"),g=f.id,j=b.get("total"),l=f.size;a=this._changeDom(a).children(".J_DelFile");a.length&&a.on("click",function(){e.remove(g);j-=l;c("#J_TotalSize").text(h.convertByteSize(j));b.set("total",j)});if(!l)return false;
if(j)j+=l;else{j=l;b.set("loaded",0)}c("#J_TotalSize").text(h.convertByteSize(j));b.set("total",j)},_start:function(){var a=this.get("tpl").start,b=this.get("target"),e=this.get("uploader"),f=e.get("type");if(!d.isString(a))return false;a=this._changeDom(a);if(f=="ajax"){if(!e.get("progressBar")){f=new k(c("#J_ProgressBar"));f.render();e.set("progressBar",f)}e.get("progressBar").set("value",0);e=a.children(".J_ProgressNum");e.html("0%");this.set("elProgressNum",e)}b.parent().addClass("current-upload-file")},
_progress:function(a){var b=a.loaded;a=Math.ceil(b/a.total*100);var e=this.get("uploader"),f=e.get("progressBar"),g=e.get("total");e=e.get("loaded");var j=this.get("elProgressNum");if(!j.length||f=="")return false;j.html(a+"%");b+=e;a=Math.ceil(b/g*100);f.set("value",a);c("#J_TotalProgressNum").text(a+"%")},_success:function(){var a=this.get("tpl").success,b=this.get("target");this.get("queue");var e=this.get("file").size,f=this.get("uploader"),g=f.get("loaded");if(!d.isString(a))return false;this._changeDom(a);
b.parent().removeClass("current-upload-file");if(!e)return false;g+=e;f.set("loaded",g)}},{ATTRS:{tpl:{value:{waiting:'<div class="clearfix"><div class="f-l">0%</div><div class="f-l uploader-icon del-icon J_DelFile"></div></div>',start:'<div class="clearfix"><div class="J_ProgressNum"><img class="loading" src="http://img01.taobaocdn.com/tps/i1/T1F5tVXjRfXXXXXXXX-16-16.gif" alt="loading" /></div></div> ',success:'<div class="uploader-icon success-icon">100%</div>',cancel:'<div>已经取消上传，<a href="#reUpload" class="J_ReUpload">点此重新上传</a> </div>',
error:'<div class="upload-error">{msg}<a href="#fileDel" class="J_FileDel">点此删除</a></div>'}}}});return i},{requires:["node","../../queue/progressBar","../../queue/status"]});
KISSY.add("form/uploader/type/ajax",function(d,m,k){function h(c){h.superclass.constructor.call(this,c);this._processData()}var i=m.all;d.mix(h,{event:d.merge(k.event,{PROGRESS:"progress"})});d.extend(h,k,{upload:function(c){if(!c){d.log("[uploader-AjaxType]:upload()，fileInput参数有误！");return false}var a=c.files;if(!a.length){d.log("[uploader-AjaxType]:upload()，不存在要上传的文件！");return false}this._addFileData(c,a[0]);this.send();return this},stop:function(){var c=this.get("xhr");if(!d.isObject(c)){d.log("[uploader-AjaxType]:stop()，io值错误！");
return false}c.abort();this.fire(h.event.STOP);return this},send:function(){var c=this;c.get("ajaxConfig");var a=c.get("action"),b=c.get("formData"),e=new XMLHttpRequest;e.upload.addEventListener("progress",function(f){c.fire(h.event.PROGRESS,{loaded:f.loaded,total:f.total})});e.onload=function(){var f={};try{f=d.JSON.parse(e.responseText)}catch(g){d.log("[uploader-AjaxType]:ajax返回结果集responseText格式不合法！")}c.fire(h.event.SUCCESS,{result:f})};e.open("POST",a,true);e.send(b);c.set("xhr",e);return c},
_processData:function(){var c=this.get("data"),a=this.get("formData");d.each(c,function(b,e){a.append(e,b)});this.set("formData",a)},_addFileData:function(c,a){if(!d.isObject(a)){d.log("[uploader-AjaxType]:_addFileData()，file参数有误！");return false}var b=this.get("formData"),e=this.get("fileDataName");if(e==""){e=i(c).attr("name");this.set("fileDataName",e)}b.append(e,a);this.set("formData",b)}},{ATTRS:{formData:{value:new FormData},ajaxConfig:{value:{type:"post",processData:false,cache:false,dataType:"json",
contentType:false}},xhr:{value:""},fileDataName:{value:""},form:{value:{}},fileInput:{value:""}}});return h},{requires:["node","./base"]});KISSY.add("form/uploader/type/base",function(d,m,k){function h(i){h.superclass.constructor.call(this,i)}d.mix(h,{event:{START:"start",STOP:"stop",SUCCESS:"success",ERROR:"error"}});d.extend(h,k,{upload:function(){},stop:function(){}},{ATTRS:{action:{value:""},data:{value:{}}}});return h},{requires:["node","base"]});
KISSY.add("form/uploader/type/iframe",function(d,m,k){function h(c){h.superclass.constructor.call(this,c)}var i=m.all;d.mix(h,{tpl:{IFRAME:'<iframe src="javascript:false;" name="{id}" id="{id}" border="no" width="1" height="1" style="display: none;" />',FORM:'<form method="post" enctype="multipart/form-data" action="{action}" target="{target}">{hiddenInputs}</form>',HIDDEN_INPUT:'<input type="hidden" name="{name}" value="{value}" />'},event:d.mix(k.event,{CREATE:"create",REMOVE:"remove"})});d.extend(h,
k,{upload:function(c){c=i(c);if(!c.length)return false;this.fire(h.event.START,{input:c});this.set("fileInput",c);this._create();this.get("form").getDOMNode().submit()},stop:function(){this.get("iframe").attr("src",'javascript:"<html></html>";');this.fire(h.event.STOP);this.fire(h.event.ERROR,{status:"abort",msg:"上传失败，原因：abort"});return this},dataToHidden:function(c){if(!d.isObject(c)||d.isEmptyObject(c)){d.log("[uploader-iframeType]:data参数不是对象或者为空！");return false}var a="",b=this.get("tpl").HIDDEN_INPUT;
if(!d.isString(b))return false;for(var e in c)a+=d.substitute(b,{name:e,value:c[e]});return a},_createIframe:function(){var c=this.get("id"),a=this.get("tpl"),b=a.IFRAME,e=this.get("iframe");if(!d.isEmptyObject(e))return e;if(!d.isString(b)){d.log("[uploader-iframeType]:iframe的模板不合法！");return false}if(!d.isString(c)){d.log("[uploader-iframeType]:id必须存在且为字符串类型！");return false}c=d.substitute(a.IFRAME,{id:c});c=i(c);c.on("load",this._iframeLoadHandler,this);i("body").append(c);this.set("iframe",c);return c},
_iframeLoadHandler:function(c){var a=c.target;c=h.event.ERROR;a=a.contentDocument||window.frames[a.id].document;if(!a||!a.body){this.fire(c,{msg:"服务器端返回数据有问题！"});return false}a=a.body.innerHTML;if(a=="")return false;try{a=JSON.parse(a)}catch(b){d.log("[uploader-iframeType]:json数据格式不合法！");this.fire(c,{msg:"数据："+a+"不是合法的json数据"})}this.fire(h.event.SUCCESS,{result:a});this._remove()},_createForm:function(){var c=this.get("id"),a=this.get("tpl").FORM,b=this.get("data"),e=this.get("action"),f=this.get("fileInput"),
g="";if(!d.isString(a)){d.log("[uploader-iframeType]:form模板不合法！");return false}if(!d.isObject(b)){d.log("[uploader-iframeType]:data参数不合法！");return false}if(!d.isString(e)){d.log("[uploader-iframeType]:action参数不合法！");return false}b=this.dataToHidden(b);if(b=="")return false;g=d.substitute(a,{action:e,target:c,hiddenInputs:b});c=i(g).append(f.clone());i("body").append(c);this.set("form",c);return c},_create:function(){var c=this._createIframe(),a=this._createForm();this.fire(h.event.CREATE,{iframe:c,
form:a})},_remove:function(){var c=this.get("form");this.get("iframe");c.remove();this.reset("form");this.fire(h.event.REMOVE,{form:c})}},{ATTRS:{tpl:{value:h.tpl},id:{value:"ks-uploader-iframe-"+d.guid()},iframe:{value:{}},form:{value:{}},fileInput:{value:""}}});return h},{requires:["node","./base"]});
KISSY.add("form/uploader/urlsInput",function(d,m,k){function h(c,a){h.superclass.constructor.call(this,a);this.set("wrapper",i(c))}var i=m.all;d.mix(h,{TPL:'<input type="hidden" id="{name}" name="{name}" value="{value}" />'});d.extend(h,k,{render:function(){var c=this.get("wrapper"),a=this.get("name");a=document.getElementsByName(a)[0];if(!d.isObject(c)){d.log("[uploader-urlsInput]:container参数不合法！");return false}a?this.set("input",i(a)):this._create()},add:function(c){if(!d.isString(c)){d.log("[uploader-urlsInput]:add()的url参数不合法！");
return false}var a=this.get("urls");if(this.isExist(c)){d.log("[uploader-urlsInput]:add()，文件路径已经存在！");return this}a.push(c);this.set("urls",a);this._val();return this},remove:function(c){var a=this.get("urls");if(!this.isExist(c)){d.log("[uploader-urlsInput]:remove()，不存在该文件路径！");return false}a=d.filter(a,function(b){return b!=c});this.set("urls",a);this._val();return a},_val:function(){var c=this.get("urls"),a=this.get("input"),b=this.get("split");c=c.join(b);a.val(c);return c},isExist:function(c){var a=
false,b=this.get("urls");if(!b.length)return false;d.each(b,function(e){if(e==c)return a=true});return a},_create:function(){var c=this.get("wrapper"),a=this.get("tpl"),b=this.get("name"),e=this.get("urls");if(!d.isString(a)||!d.isString("name")){d.log("[uploader-urlsInput]:_create()，tpl和name属性不合法！");return false}a=i(d.substitute(a,{name:b,value:e}));c.append(a);this.set("input",a);return a}},{ATTRS:{name:{value:""},urls:{value:[]},tpl:{value:h.TPL},split:{value:",",setter:function(c){this._val();
return c}},input:{value:""},wrapper:{value:""}}});return h},{requires:["node","base"]});
